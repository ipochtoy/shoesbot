# Операции ShoesBot

## Быстрый старт

### Первоначальная настройка (один раз)

```bash
ssh gcp-shoesbot
cd /home/pochtoy/shoesbot

# 1. Критический бекап
./critical_backup.sh

# 2. Настройка DEV окружения
./setup_dev_environment.sh
./install_dev_service.sh

# 3. Настройка GCS (опционально)
./setup_gcs.sh

# 4. Отключение rsync
./disable_rsync_deploy.sh

# 5. Настройка автоматических бекапов
./setup_cron_backup.sh

# 6. Установка watchdog
./install_watchdog.sh

# 7. Установка git hooks
./install_git_hooks.sh

# 8. Исправление production settings
./fix_settings_production.sh

# 9. Перезапуск Django
./restart_django.sh
```

## Ежедневные операции

### Деплой новой версии

```bash
ssh gcp-shoesbot
cd /home/pochtoy/shoesbot
./deploy.sh
```

Скрипт автоматически:
- Создаст бекап БД
- Загрузит изменения из GitHub
- Запустит миграции
- Соберет статику
- Перезапустит Django
- Выполнит health check
- Откатится при ошибках

### Полная проверка системы

```bash
ssh gcp-shoesbot /home/pochtoy/shoesbot/full_check.sh
```

### Запуск тестов

```bash
ssh gcp-shoesbot /home/pochtoy/shoesbot/run_tests.sh
```

## Восстановление и откат

### Откат на предыдущую версию

```bash
ssh gcp-shoesbot
cd /home/pochtoy/shoesbot

# Посмотреть последние коммиты
git log --oneline -10

# Откатиться на нужный коммит
git reset --hard COMMIT_HASH

# Перезапустить Django
./restart_django.sh
```

### Восстановление БД из бекапа

```bash
ssh gcp-shoesbot

# Посмотреть доступные бекапы
ls -lh /home/pochtoy/backups/critical/

# Остановить Django
sudo systemctl stop shoesdjango.service

# Восстановить БД
cp /home/pochtoy/backups/critical/db-ДАТА.sqlite3 /home/pochtoy/shoesbot/shoessite/db.sqlite3

# Запустить Django
sudo systemctl start shoesdjango.service
```

## Мониторинг

### Проверка здоровья

```bash
ssh gcp-shoesbot /home/pochtoy/shoesbot/healthcheck.sh
```

### Логи

```bash
# Логи бота
ssh gcp-shoesbot "tail -50 /home/pochtoy/shoesbot/bot.log"

# Логи Django
ssh gcp-shoesbot "tail -50 /home/pochtoy/shoesbot/django.log"

# Логи watchdog
ssh gcp-shoesbot "tail -20 /home/pochtoy/shoesbot/watchdog.log"

# Статус сервисов
ssh gcp-shoesbot "systemctl status shoesbot.service shoesdjango.service shoesbot-watchdog.service"
```

### Перезапуск сервисов

```bash
# Перезапуск Django (безопасно)
ssh gcp-shoesbot "sudo systemctl restart shoesdjango.service"

# Перезапуск бота (ТОЛЬКО при крайней необходимости!)
ssh gcp-shoesbot "sudo systemctl restart shoesbot.service"

# Перезапуск watchdog
ssh gcp-shoesbot "sudo systemctl restart shoesbot-watchdog.service"
```

## Dev окружение

### Работа с dev сервером

```bash
# Dev сервер работает на порту 8001
# URL: http://localhost:8001/admin/

# Статус dev сервера
ssh gcp-shoesbot "sudo systemctl status shoesdjango-dev.service"

# Перезапуск dev сервера
ssh gcp-shoesbot "sudo systemctl restart shoesdjango-dev.service"

# Dev данные находятся в:
# /home/pochtoy/shoesbot/dev_data/db.sqlite3
# /home/pochtoy/shoesbot/dev_data/media/
```

## Бекапы

### Ручной бекап

```bash
ssh gcp-shoesbot /home/pochtoy/shoesbot/backup_media.sh
```

### Проверка автоматических бекапов

```bash
# Проверить cron задачу
ssh gcp-shoesbot "crontab -l | grep backup"

# Посмотреть логи бекапов
ssh gcp-shoesbot "tail -30 /home/pochtoy/backups/backup.log"

# Список бекапов
ssh gcp-shoesbot "ls -lh /home/pochtoy/backups/db/"
```

## Проверка веб-интерфейса

После любых изменений проверь:

1. **Админка**: https://pochtoy.us/admin/
   - Верстка загружается?
   - Логин работает?
   - Фото отображаются?

2. **Бот в Telegram**
   - Отправь /ping
   - Отправь фото
   - Проверь что обрабатывается

## ЗАПРЕЩЕНО

### Никогда не делай:

- ❌ Rsync с локальной машины на production
- ❌ Ручной запуск Django (только через systemctl)
- ❌ Редактирование settings.py на сервере вручную
- ❌ Удаление папки media
- ❌ Остановка бота без веской причины
- ❌ Force push в main
- ❌ Деплой без тестов
- ❌ Изменения в production БД напрямую

### Всегда делай:

- ✅ Бекап перед рискованными действиями
- ✅ Тесты перед деплоем
- ✅ Коммиты в Git для всех изменений
- ✅ Проверка через full_check.sh после изменений
- ✅ Мониторинг логов после деплоя

## Решение проблем

### Слетела верстка в админке

```bash
ssh gcp-shoesbot
cd /home/pochtoy/shoesbot
./fix_settings_production.sh
./restart_django.sh
```

### Django не запускается

```bash
ssh gcp-shoesbot
cd /home/pochtoy/shoesbot

# Проверить логи
tail -100 django.log

# Проверить что порт свободен
sudo lsof -i :8000

# Попробовать запустить вручную для диагностики
cd shoessite
../.venv/bin/python manage.py runserver 0.0.0.0:8000
```

### Бот не отвечает

```bash
ssh gcp-shoesbot

# Проверить статус
sudo systemctl status shoesbot.service

# Посмотреть логи
tail -100 /home/pochtoy/shoesbot/bot.log

# Перезапустить (крайняя мера!)
sudo systemctl restart shoesbot.service
```

### Диск заполнен

```bash
ssh gcp-shoesbot

# Проверить использование
df -h

# Найти большие файлы
du -h /home/pochtoy | sort -h | tail -20

# Почистить старые логи
find /home/pochtoy/shoesbot -name "*.log.*" -mtime +30 -delete

# Почистить старые бекапы
find /home/pochtoy/backups -type f -mtime +30 -delete
```

## Контакты и поддержка

- GitHub Issues: https://github.com/ipochtoy/shoesbot/issues
- Документация: README.md
- Этот файл: ОПЕРАЦИИ.md
