<!DOCTYPE html>
<html>
<head>
    <title>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ç–æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f7fa; padding: 20px; }
        
        h1 { margin-bottom: 20px; }
        
        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .groups-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .group {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .group-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            min-height: 100px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            border: 2px dashed #d1d5db;
        }
        
        .photo-grid.drag-over {
            background: #eff6ff;
            border-color: #2563eb;
        }
        
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: move;
            transition: transform 0.2s;
        }
        
        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .photo-item.dragging {
            opacity: 0.5;
        }
        
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        .photo-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .stats {
            color: #6b7280;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üì¶ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ç–æ</h1>
    
    <div class="toolbar">
        <button class="btn btn-success" onclick="createNewGroup()">‚ûï –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</button>
        <button class="btn btn-primary" onclick="autoGroup()" style="background: #6b7280;">ü§ñ –ê–≤—Ç–æ–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</button>
        <button class="btn btn-danger" onclick="clearBuffer()" style="background: #dc2626;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±—É—Ñ–µ—Ä</button>
        <div class="stats">
            –í—Å–µ–≥–æ —Ñ–æ—Ç–æ: <strong id="total-count">{{ photos.count }}</strong> | 
            –ù–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: <strong id="unsorted-count">0</strong>
        </div>
    </div>
    
    <p style="color: #6b7280; margin: 10px 0; font-size: 14px;">
        üí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π —Ñ–æ—Ç–æ –∏–∑ "–ù–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ" –≤ –≥—Ä—É–ø–ø—ã. –ö–æ–≥–¥–∞ –≥—Ä—É–ø–ø–∞ –≥–æ—Ç–æ–≤–∞ - –∂–º–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞"
    </p>
    
    <div class="groups-container" id="groups-container">
        <!-- –ì—Ä—É–ø–ø—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
    </div>
    
    <script>
        let groups = [];
        let photos = {{ photos_json|safe }};
        
        function render() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–æ—Ç–æ
            const grouped = {};
            photos.forEach(p => {
                const gid = p.group_id || 'ungrouped';
                if (!grouped[gid]) grouped[gid] = [];
                grouped[gid].push(p);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
            const unsortedCount = grouped['ungrouped'] ? grouped['ungrouped'].length : 0;
            document.getElementById('unsorted-count').textContent = unsortedCount;
            document.getElementById('total-count').textContent = photos.length;
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ù–ï–°–û–†–¢–ò–†–û–í–ê–ù–ù–´–ï (–≤—Å–µ–≥–¥–∞ –≤–≤–µ—Ä—Ö—É)
            if (grouped['ungrouped']) {
                const groupDiv = createGroupElement('ungrouped', grouped['ungrouped'], '–ù–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ üëá –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –æ—Ç—Å—é–¥–∞ –≤ –≥—Ä—É–ø–ø—ã');
                container.appendChild(groupDiv);
            }
            
            // –ü–æ—Ç–æ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã
            Object.keys(grouped).sort((a, b) => {
                if (a === 'ungrouped') return -1;
                if (b === 'ungrouped') return 1;
                return parseInt(a) - parseInt(b);
            }).forEach(gid => {
                if (gid === 'ungrouped') return; // –£–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏
                
                const groupPhotos = grouped[gid];
                const ggLabels = [...new Set(groupPhotos.filter(p => p.gg_label).map(p => p.gg_label))];
                const label = `–ì—Ä—É–ø–ø–∞ ${gid}` + (ggLabels.length > 0 ? ` [${ggLabels.join(', ')}]` : '');
                
                const groupDiv = createGroupElement(gid, groupPhotos, label);
                container.appendChild(groupDiv);
            });
        }
        
        function createGroupElement(gid, groupPhotos, label) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group';
            groupDiv.dataset.groupId = gid;
            
            groupDiv.innerHTML = `
                <div class="group-header">
                    <div class="group-title">${label} (${groupPhotos.length} —Ñ–æ—Ç–æ)</div>
                    <div>
                        ${gid !== 'ungrouped' ? `
                            <button class="btn btn-success" onclick="sendGroupToBot(${gid})">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞</button>
                            <button class="btn btn-danger" onclick="deleteGroup(${gid})" style="background: #dc2626;">üóëÔ∏è</button>
                        ` : ''}
                    </div>
                </div>
                <div class="photo-grid" data-group-id="${gid}" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                    ${groupPhotos.map(p => `
                        <div class="photo-item" draggable="true" data-photo-id="${p.id}" ondragstart="drag(event)" ondragend="dragEnd(event)">
                            <img src="${p.image_url}" alt="–§–æ—Ç–æ ${p.id}">
                            ${p.gg_label ? `<div class="photo-label">${p.gg_label}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            return groupDiv;
        }
        
        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function dragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function drag(e) {
            const photoItem = e.target.closest('.photo-item');
            if (photoItem) {
                e.dataTransfer.setData('photo_id', photoItem.dataset.photoId);
                photoItem.classList.add('dragging');
                console.log('Dragging photo:', photoItem.dataset.photoId);
            }
        }
        
        function dragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        function drop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const photoId = parseInt(e.dataTransfer.getData('photo_id'));
            const newGroupId = e.currentTarget.dataset.groupId;
            
            console.log('Drop: photo', photoId, 'to group', newGroupId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É
            const photo = photos.find(p => p.id === photoId);
            if (photo) {
                const oldGroup = photo.group_id;
                photo.group_id = newGroupId === 'ungrouped' ? null : parseInt(newGroupId);
                updatePhotoGroup(photoId, photo.group_id);
                console.log(`Moved photo ${photoId} from group ${oldGroup} to ${photo.group_id}`);
                render();
            }
        }
        
        function deleteGroup(groupId) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É ${groupId}? –§–æ—Ç–æ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ –Ω–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ.`)) return;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ñ–æ—Ç–æ –≥—Ä—É–ø–ø—ã –≤ –Ω–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            photos.forEach(p => {
                if (p.group_id === groupId) {
                    p.group_id = null;
                    updatePhotoGroup(p.id, null);
                }
            });
            
            render();
        }
        
        async function updatePhotoGroup(photoId, groupId) {
            await fetch(`/photos/api/update-photo-group/${photoId}/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ group_id: groupId })
            });
        }
        
        function createNewGroup() {
            const maxGroup = Math.max(0, ...photos.filter(p => p.group_id).map(p => p.group_id));
            const newGroupId = maxGroup + 1;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é –≥—Ä—É–ø–ø—É
            photos.push({ id: -newGroupId, group_id: newGroupId, image_url: '', gg_label: '' });
            render();
        }
        
        function autoGroup() {
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ GG –ª–µ–π–±–ª–∞–º –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û
            // GG681, GG681, GG700, GG681 = 3 –≥—Ä—É–ø–ø—ã (–æ—Ç—Å–µ—á–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ GG)
            
            let groupCounter = 0;
            let lastGG = null;
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –ø–æ ID (–ø–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏)
            const sortedPhotos = [...photos].sort((a, b) => a.id - b.id);
            
            sortedPhotos.forEach(p => {
                if (p.gg_label && p.gg_label !== '') {
                    // –ï—Å–ª–∏ GG –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ —Å GG - –Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
                    if (p.gg_label !== lastGG) {
                        groupCounter++;
                        lastGG = p.gg_label;
                        console.log(`New group ${groupCounter} for ${p.gg_label}`);
                    }
                    
                    p.group_id = groupCounter;
                    updatePhotoGroup(p.id, p.group_id);
                } else {
                    // –§–æ—Ç–æ –±–µ–∑ GG - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π GG (–æ—Ç—Å–µ—á–∫–∞)
                    p.group_id = null;
                    lastGG = null;
                }
            });
            
            render();
            alert(`‚úÖ –°–æ–∑–¥–∞–Ω–æ –≥—Ä—É–ø–ø: ${groupCounter}\n\n–§–æ—Ç–æ –±–µ–∑ GG –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏`);
        }
        
        async function sendGroupToBot(groupId) {
            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É ${groupId} –≤ –±–æ—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏?`)) return;
            
            const response = await fetch(`/photos/api/send-group-to-bot/${groupId}/`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            if (data.success) {
                alert(`‚úÖ –ì—Ä—É–ø–ø–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –±–æ—Ç–∞`);
                // –£–¥–∞–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
                photos = photos.filter(p => p.group_id !== groupId);
                render();
            } else {
                alert(`–û—à–∏–±–∫–∞: ${data.error}`);
            }
        }
        
        async function detectGGLabels() {
            if (!confirm('–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å GG –ª–µ–π–±–ª—ã –Ω–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-2 –º–∏–Ω—É—Ç—ã.')) return;
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞—é...';
            
            const response = await fetch('/photos/api/detect-gg-in-buffer/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ GG –ª–µ–π–±–ª–æ–≤: ${data.found_count}`);
                location.reload();
            } else {
                alert(`–û—à–∏–±–∫–∞: ${data.error}`);
                btn.disabled = false;
                btn.textContent = 'üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å GG –Ω–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ';
            }
        }
        
        async function sendAllToBot() {
            if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –í–°–ï –≥—Ä—É–ø–ø—ã –≤ –±–æ—Ç–∞?')) return;
            
            const groupIds = [...new Set(photos.filter(p => p.group_id).map(p => p.group_id))];
            
            for (let gid of groupIds) {
                await sendGroupToBot(gid);
                await new Promise(r => setTimeout(r, 15000)); // 15 —Å–µ–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª
            }
        }
        
        async function clearBuffer() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ñ–æ—Ç–æ –∏–∑ –±—É—Ñ–µ—Ä–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;
            if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å? –§–æ—Ç–æ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!')) return;
            
            const response = await fetch('/photos/api/clear-buffer/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            if (data.success) {
                alert(`‚úÖ –£–¥–∞–ª–µ–Ω–æ —Ñ–æ—Ç–æ: ${data.deleted_count}`);
                location.reload();
            } else {
                alert(`–û—à–∏–±–∫–∞: ${data.error}`);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        render();
        document.getElementById('total-count').textContent = photos.length;
    </script>
</body>
</html>

