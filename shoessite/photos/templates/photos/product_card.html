{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ {{ card.correlation_id }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 220px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 12px 0;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-logo {
            padding: 0 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }
        .sidebar-logo h1 {
            font-size: 18px;
            color: #2563eb;
            font-weight: 600;
        }
        .sidebar-menu {
            list-style: none;
        }
        .sidebar-menu li {
            margin-bottom: 4px;
        }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 13px;
            transition: background 0.2s;
        }
        .sidebar-menu a:hover {
            background: #f3f4f6;
        }
        .sidebar-menu a.active {
            background: #eff6ff;
            color: #2563eb;
            font-weight: 500;
        }
        .sidebar-badge {
            background: #2563eb;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Top Header */
        .top-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .top-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .back-link {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .back-link:hover {
            color: #2563eb;
        }
        .top-header-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
        }
        .top-header-meta {
            font-size: 12px;
            color: #6b7280;
        }
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            overflow: hidden;
        }
        .card-header {
            background: #eff6ff;
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
        }
        .card-body {
            padding: 12px 15px;
        }
        
        /* Buttons */
        .btn {
            padding: 6px 12px;
            border-radius: 5px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* Photos Grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        .photo-item:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }
        .photo-item.main-photo {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        .photo-item img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
        }
        .photo-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 100px;
        }
        .photo-controls .btn {
            padding: 3px 5px;
            font-size: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 3px;
        }
        .photo-controls .btn-star {
            background: rgba(245, 158, 11, 0.9);
        }
        .photo-controls .btn-delete {
            background: rgba(239, 68, 68, 0.9);
        }
        .photo-main-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            z-index: 10;
        }
        .photo-info {
            padding: 4px 6px;
            background: #f9fafb;
            font-size: 10px;
            color: #6b7280;
        }
        
        /* Barcodes Section */
        .barcodes-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            padding: 8px 10px;
            background: #f9fafb;
            border-radius: 6px;
        }
        .barcode-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }
        .barcode-tag.gg {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        .barcode-search-btn {
            background: #10b981;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 10px;
            border: none;
            cursor: pointer;
        }
        
        /* AI Summary Section */
        .ai-summary-section {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }
        .ai-summary-section .card-header {
            background: #d1fae5;
        }
        .summary-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
            font-size: 12px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 13px;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            cursor: pointer;
        }
        .lightbox-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Stock Photos */
        .stock-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }
        .stock-photo-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stock-photo-item:hover {
            transform: scale(1.05);
            border-color: #2563eb;
        }
        .stock-photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .stock-photo-add {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            padding: 6px;
            text-align: center;
        }
        .stock-photo-add .btn {
            width: 100%;
            justify-content: center;
            padding: 4px 6px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-logo">
            <h1>SHOESBOT</h1>
            </div>
        <ul class="sidebar-menu">
            <li><a href="/admin/photos/photobatch/" class="active">üì¶ –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</a></li>
            <li><a href="/photos/sorting/">üîÑ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–æ—Ç–æ</a></li>
            <li><a href="/admin/photos/photobatch/">üì∏ –§–æ—Ç–æ <span class="sidebar-badge">{{ photos|length }}</span></a></li>
            <li><a href="/admin/photos/barcoderesult/">üìä –ë–∞—Ä–∫–æ–¥—ã</a></li>
        </ul>
        </div>
        
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <div class="top-header">
            <div class="top-header-left">
                <a href="/admin/photos/photobatch/" class="back-link">‚Üê –ù–∞–∑–∞–¥</a>
                <div>
                    <div class="top-header-title">{{ card.title|default:card.correlation_id }}</div>
                    <div class="top-header-meta">ID: {{ card.correlation_id }} | –°—Ç–∞—Ç—É—Å: {{ card.get_status_display }} | –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ card.uploaded_at|date:"d.m.Y H:i" }}</div>
                </div>
            </div>
            <div class="user-menu">
                <div class="user-icon">üë§</div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area" data-card-id="{{ card.id }}">
            <!-- Photos Section -->
            <div class="card">
                <div class="card-header">
                    <h2>üì∏ –§–æ—Ç–æ ({{ photos|length }})</h2>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="document.getElementById('file-input').click()" class="btn btn-success btn-sm">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                        <input type="file" id="file-input" multiple accept="image/*" style="display: none;" onchange="uploadPhotosFromComputer()">
                        <button type="button" onclick="searchStockPhotos()" class="btn btn-primary btn-sm">
                            üîç –ù–∞–π—Ç–∏ —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ
                        </button>
                    </div>
                </div>
                <div class="card-body">
                <div class="photos-grid">
                    {% for photo in photos %}
                        <div class="photo-item {% if photo.is_main %}main-photo{% endif %}" id="photo-{{ photo.id }}">
                            {% if photo.is_main %}
                            <div class="photo-main-badge">‚≠ê –ì–ª–∞–≤–Ω–æ–µ</div>
                            {% endif %}
                            <div class="photo-controls">
                                <button type="button" onclick="setMainPhoto({{ photo.id }})" class="btn btn-star" title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω–æ–π">‚≠ê</button>
                                <button type="button" onclick="rotatePhoto({{ photo.id }}, 'left')" class="btn" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ª–µ–≤–æ">‚Ü∂</button>
                                <button type="button" onclick="rotatePhoto({{ photo.id }}, 'right')" class="btn" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ø—Ä–∞–≤–æ">‚Ü∑</button>
                                <button type="button" onclick="deletePhoto({{ photo.id }})" class="btn btn-delete" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                            </div>
                            <img src="{{ photo.image.url }}" alt="–§–æ—Ç–æ {{ photo.id }}" onclick="openLightbox('{{ photo.image.url }}')" style="cursor: pointer;">
                            <div class="photo-info">
                            –ö–æ–¥–æ–≤: {{ photo.barcodes.count }}
                                <button type="button" onclick="reprocessPhoto({{ photo.id }})" class="btn btn-sm" style="margin-top: 4px; width: 100%; background: #ef4444; color: white; padding: 3px 6px; font-size: 10px;">
                                    üîç –ö–æ–¥—ã
                            </button>
                                <div style="display: flex; gap: 2px; margin-top: 4px;">
                                    <button type="button" onclick="enhancePhoto({{ photo.id }}, 'ghost_mannequin')" class="btn btn-sm" style="flex: 1; background: #8b5cf6; color: white; padding: 3px 4px; font-size: 9px;" title="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ (FASHN AI, ~30 —Å–µ–∫)">
                                        üë§
                                    </button>
                                    <button type="button" onclick="enhancePhoto({{ photo.id }}, 'product_beautifier')" class="btn btn-sm" style="flex: 1; background: #ec4899; color: white; padding: 3px 4px; font-size: 9px;" title="–£–ª—É—á—à–∏—Ç—å —Ñ–æ—Ç–æ (Photoroom)">
                                        ‚ú®
                                    </button>
                                </div>
                        </div>
                    </div>
                    {% endfor %}
            </div>
            
                    <!-- Stock Photos Section -->
                    <div id="stock-photos-section" style="display: none; margin-top: 12px;">
                        <div class="card">
                            <div class="card-header">
                                <h2>üì∑ –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ</h2>
                                <button type="button" onclick="closeStockPhotos()" class="btn btn-sm" style="background: #6b7280;">
                                    ‚úï –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
                            <div class="card-body" style="padding: 8px 12px;">
                                <div id="stock-photos-grid" class="stock-photos-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Barcodes Section -->
            <div class="card" style="margin-top: 12px;">
                <div class="card-header">
                    <h2>–ë–∞—Ä–∫–æ–¥—ã</h2>
                    <button type="button" onclick="showAddBarcodeForm()" class="btn btn-success btn-sm">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–∞—Ä–∫–æ–¥
                    </button>
                </div>
                <div class="card-body" style="padding: 8px 12px;">
                    <div id="add-barcode-form" style="display: none; margin-bottom: 12px; padding: 12px; background: #f0fdf4; border-radius: 6px;">
                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; margin-bottom: 4px; display: block;">–ö–æ–¥:</label>
                                <input type="text" id="barcode-data" placeholder="197613340718" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;">
                            </div>
                            <div style="width: 150px;">
                                <label style="font-size: 12px; margin-bottom: 4px; display: block;">–¢–∏–ø:</label>
                                <select id="barcode-type" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;">
                                    <option value="EAN13">EAN13</option>
                                    <option value="UPCA">UPC-A</option>
                                    <option value="CODE39">CODE39</option>
                                    <option value="CODE128">CODE128</option>
                                    <option value="QRCODE">QR Code</option>
                                </select>
                            </div>
                            <button type="button" onclick="addBarcodeManually()" class="btn btn-success">
                                ‚úÖ –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                            <button type="button" onclick="hideAddBarcodeForm()" class="btn btn-sm" style="background: #6b7280; color: white;">
                                ‚úï
                            </button>
                        </div>
                    </div>
                    <div class="barcodes-compact">
                {% if all_barcodes %}
                        {% for barcode in all_barcodes %}
                        <div class="barcode-tag" style="cursor: pointer;" onclick="searchByBarcode('{{ barcode.data }}')" title="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –∏ —Å—Ç–æ–∫–æ–≤—ã—Ö —Ñ–æ—Ç–æ –ø–æ –±–∞—Ä–∫–æ–¥—É">
                            <button type="button" onclick="event.stopPropagation(); searchByBarcode('{{ barcode.data }}')" class="barcode-search-btn">üîç</button>
                            <span style="font-weight: 500;">{{ barcode.data }}</span>
                            <span style="color: #9ca3af; font-size: 11px;">{{ barcode.symbology }}</span>
                        </div>
                        {% endfor %}
                        {% endif %}
                        {% if gg_labels %}
                        <span style="color: #92400e; font-weight: 600; font-size: 12px;">üè∑Ô∏è GG:</span>
                        {% for gg in gg_labels %}
                        <span class="barcode-tag gg" style="cursor: pointer;" onclick="searchByBarcode('{{ gg }}')" title="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –∏ —Å—Ç–æ–∫–æ–≤—ã—Ö —Ñ–æ—Ç–æ –ø–æ GG –ª–µ–π–±–µ">{{ gg }}</span>
                        {% endfor %}
                        {% endif %}
                    </div>
                    <div id="search-results" style="display: none; margin-top: 12px;">
                        <div id="search-loading" style="display: none; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 12px;">–ü–æ–∏—Å–∫...</div>
                        <div id="search-content"></div>
                    </div>
                </div>
            </div>
            
            <!-- AI Summary Section -->
            <div class="card ai-summary-section">
                <div class="card-header">
                    <h2>ü§ñ AI –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>
                </div>
                <div class="card-body">
                    <div style="text-align: center; padding: 12px;">
                        <button type="button" onclick="generateSummary()" id="generate-summary-btn" class="btn btn-success" style="width: 100%;">
                            ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                        </button>
                        <div id="summary-loading" style="display: none; margin-top: 10px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 12px;">
                            <p>‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ–ø–∏—Å–∞–Ω–∏–µ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥.</p>
                        </div>
                        {% if ai_summary %}
                        <details style="margin-top: 12px; text-align: left;">
                            <summary style="cursor: pointer; font-size: 12px; color: #6b7280; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                üìù –ü–æ–∫–∞–∑–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–≤–æ–¥–∫—É
                            </summary>
                            <div style="margin-top: 8px;">
                                <textarea id="ai-summary-content" class="summary-textarea" placeholder="–°–≤–æ–¥–∫–∞ –æ—Ç OpenAI...">{{ ai_summary }}</textarea>
                                <div style="margin-top: 6px; display: flex; gap: 8px; align-items: center;">
                                    <button type="button" class="btn btn-sm" onclick="startVoiceInput('ai-summary-content', event)" style="background: #9333ea; color: white;">
                                        üé§ –î–∏–∫—Ç–æ–≤–∞—Ç—å
                                    </button>
                                    <button type="button" class="btn btn-sm" onclick="saveAISummary()" style="background: #6366f1; color: white;">
                                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                    <button type="button" onclick="applyAISummaryToCard()" class="btn btn-sm" style="background: #10b981; color: white;">
                                        ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –ø–æ–ª—è–º
                                    </button>
                                </div>
                            </div>
                        </details>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Product Form -->
            <div class="card">
                <div class="card-header">
                    <h2>üìù –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
                </div>
                <div class="card-body">
                    <form method="post" class="product-form">
                        {% csrf_token %}
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <input type="text" name="title" value="{{ card.title }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" style="width: 100%; min-height: 200px;">{{ card.description }}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞</label>
                        <input type="number" name="price" step="0.01" value="{{ card.price }}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                        <select name="condition">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                            <option value="new" {% if card.condition == 'new' %}selected{% endif %}>–ù–æ–≤–æ–µ</option>
                            <option value="used" {% if card.condition == 'used' %}selected{% endif %}>–ë/—É</option>
                            <option value="refurbished" {% if card.condition == 'refurbished' %}selected{% endif %}>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                                <label>–ë—Ä–µ–Ω–¥</label>
                                <input type="text" name="brand" value="{{ card.brand }}" placeholder="–ë—Ä–µ–Ω–¥">
                    </div>
                    <div class="form-group">
                                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <input type="text" name="category" value="{{ card.category }}" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä</label>
                        <input type="text" name="size" value="{{ card.size }}" placeholder="–†–∞–∑–º–µ—Ä">
                    </div>
                    <div class="form-group">
                        <label>–¶–≤–µ—Ç</label>
                        <input type="text" name="color" value="{{ card.color }}" placeholder="–¶–≤–µ—Ç">
                    </div>
                </div>
                <div class="form-group">
                    <label>SKU/–ê—Ä—Ç–∏–∫—É–ª</label>
                            <input type="text" name="sku" value="{{ card.sku }}" placeholder="SKU/–ê—Ä—Ç–∏–∫—É–ª">
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" name="quantity" min="1" value="{{ card.quantity|default:1 }}" placeholder="1">
                </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
            </form>
                </div>
            </div>
                    </div>
            </div>
            
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
        </div>
    </div>
    
    <!-- Lightbox –¥–ª—è —Å—Ç–æ–∫–æ–≤—ã—Ö —Ñ–æ—Ç–æ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
    <div id="stock-lightbox" class="lightbox" onclick="closeStockLightbox()">
        <span class="lightbox-close" onclick="closeStockLightbox()">&times;</span>
        
        <!-- –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div style="position: absolute; top: 50%; left: 20px; transform: translateY(-50%); z-index: 10001;">
            <button onclick="event.stopPropagation(); prevStockPhoto()" 
                    style="background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                ‚Üê
            </button>
        </div>
        <div style="position: absolute; top: 50%; right: 20px; transform: translateY(-50%); z-index: 10001;">
            <button onclick="event.stopPropagation(); nextStockPhoto()" 
                    style="background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                ‚Üí
            </button>
        </div>
        
        <div class="lightbox-content" onclick="event.stopPropagation()" style="text-align: center;">
            <img id="stock-lightbox-img" src="" alt="–°—Ç–æ–∫–æ–≤–æ–µ —Ñ–æ—Ç–æ" style="max-width: 90vw; max-height: 80vh; object-fit: contain;">
            <div style="margin-top: 16px;">
                <button onclick="event.stopPropagation(); addCurrentStockPhoto()" 
                        class="btn btn-success" 
                        style="padding: 12px 24px; font-size: 14px;">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ
                </button>
                <div id="stock-photo-counter" style="margin-top: 8px; color: white; font-size: 14px;"></div>
            </div>
        </div>
    </div>
    
    <script>
        function openLightbox(imgSrc) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = imgSrc;
            lightbox.style.display = 'block';
        }
        
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }
        
        // Lightbox –¥–ª—è —Å—Ç–æ–∫–æ–≤—ã—Ö —Ñ–æ—Ç–æ
        let stockPhotosArray = [];
        let currentStockPhotoIndex = 0;
        
        function openStockPhotoLightbox(index) {
            if (!stockPhotosArray || stockPhotosArray.length === 0) return;
            
            currentStockPhotoIndex = index;
            const lightbox = document.getElementById('stock-lightbox');
            const img = document.getElementById('stock-lightbox-img');
            const counter = document.getElementById('stock-photo-counter');
            
            const photo = stockPhotosArray[currentStockPhotoIndex];
            img.src = photo.url || photo.thumbnail;
            counter.textContent = `${currentStockPhotoIndex + 1} / ${stockPhotosArray.length}`;
            
            lightbox.style.display = 'block';
        }
        
        function closeStockLightbox() {
            document.getElementById('stock-lightbox').style.display = 'none';
        }
        
        function nextStockPhoto() {
            if (currentStockPhotoIndex < stockPhotosArray.length - 1) {
                openStockPhotoLightbox(currentStockPhotoIndex + 1);
            } else {
                openStockPhotoLightbox(0); // –ó–∞—Ü–∏–∫–ª–∏–≤–∞–µ–º
            }
        }
        
        function prevStockPhoto() {
            if (currentStockPhotoIndex > 0) {
                openStockPhotoLightbox(currentStockPhotoIndex - 1);
            } else {
                openStockPhotoLightbox(stockPhotosArray.length - 1); // –ó–∞—Ü–∏–∫–ª–∏–≤–∞–µ–º
            }
        }
        
        function addCurrentStockPhoto() {
            const photo = stockPhotosArray[currentStockPhotoIndex];
            if (photo) {
                addPhotoFromUrl(photo.url);
                closeStockLightbox();
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.addEventListener('keydown', function(e) {
            const stockLightbox = document.getElementById('stock-lightbox');
            if (stockLightbox.style.display === 'block') {
                if (e.key === 'ArrowRight') {
                    nextStockPhoto();
                } else if (e.key === 'ArrowLeft') {
                    prevStockPhoto();
                } else if (e.key === 'Escape') {
                    closeStockLightbox();
                } else if (e.key === 'Enter') {
                    addCurrentStockPhoto();
                }
            }
        });
        
        async function reprocessPhoto(photoId) {
            const btn = event.target;
            const photoItem = btn.closest('.photo-item');
            
            if (confirm('–ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å –∫–æ–¥—ã —Å —ç—Ç–æ–≥–æ —Ñ–æ—Ç–æ? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.')) {
                photoItem.classList.add('processing');
                btn.disabled = true;
                btn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                
                try {
                    const response = await fetch(`/photos/api/reprocess-photo/${photoId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        let message = '';
                        if (data.barcodes_found > 0) {
                            message = `‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤: ${data.barcodes_found}\n\n–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–¥—ã:\n${data.barcodes.join('\n')}`;
                        } else {
                            message = `‚ÑπÔ∏è –ù–æ–≤—ã—Ö –∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${data.total_results || 0}`;
                        }
                        
                        if (data.api_info) {
                            message += `\n\nüì° –°—Ç–∞—Ç—É—Å API:\n${data.api_info.join('\n')}`;
                        }
                        
                        if (data.debug_info) {
                            message += `\n\nüîç –û—Ç–ª–∞–¥–∫–∞:\n`;
                            message += `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: ${data.debug_info.used_pipeline || 'unknown'}\n`;
                            message += `Google Vision: ${data.debug_info.google_vision_called ? '–≤—ã–∑–≤–∞–Ω' : '–Ω–µ –≤—ã–∑–≤–∞–Ω'}\n`;
                            message += `OpenAI: ${data.debug_info.openai_called ? '–≤—ã–∑–≤–∞–Ω' : '–Ω–µ –≤—ã–∑–≤–∞–Ω'}`;
                        }
                        
                        alert(message);
                        window.location.reload();
                    } else {
                        let errorMsg = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                        if (data.traceback) {
                            console.error('Traceback:', data.traceback);
                            errorMsg += '\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.';
                        }
                        alert(errorMsg);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: ' + error.message);
                } finally {
                    photoItem.classList.remove('processing');
                    btn.disabled = false;
                    btn.textContent = 'üîç –ü—Ä–æ—á–µ—Å—Ç—å –∫–æ–¥—ã';
                }
            }
        }
        
        function showAddBarcodeForm() {
            document.getElementById('add-barcode-form').style.display = 'block';
            document.getElementById('barcode-data').focus();
        }
        
        function hideAddBarcodeForm() {
            document.getElementById('add-barcode-form').style.display = 'none';
            document.getElementById('barcode-data').value = '';
        }
        
        async function addBarcodeManually() {
            const cardId = document.querySelector('.content-area').dataset.cardId;
            const barcodeData = document.getElementById('barcode-data').value.trim();
            const barcodeType = document.getElementById('barcode-type').value;
            
            if (!barcodeData) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
                return;
            }
            
            try {
                const response = await fetch(`/photos/api/add-barcode/${cardId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        barcode: barcodeData,
                        symbology: barcodeType
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–∞—Ä–∫–æ–¥–∞: ' + error.message);
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        async function searchStockPhotos() {
            const cardId = document.querySelector('.content-area').dataset.cardId;
            const stockSection = document.getElementById('stock-photos-section');
            const stockGrid = document.getElementById('stock-photos-grid');
            
            stockSection.style.display = 'block';
            stockGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6b7280;">üîç –ò—â—É —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ...</div>';
            
            try {
                const response = await fetch(`/photos/api/search-stock-photos/${cardId}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                });
                
                const data = await response.json();
                
                if (data.success && data.images && data.images.length > 0) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ –¥–ª—è lightbox
                    stockPhotosArray = data.images;
                    
                    stockGrid.innerHTML = '';
                    data.images.forEach((img, index) => {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'stock-photo-item';
                        imgDiv.style.cursor = 'pointer';
                        
                        const imgEl = document.createElement('img');
                        imgEl.src = img.thumbnail || img.url;
                        imgEl.onerror = function() {
                            this.src = img.url;
                        };
                        
                        // –ö–ª–∏–∫ –ø–æ —Ñ–æ—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç lightbox
                        imgDiv.onclick = () => {
                            openStockPhotoLightbox(index);
                        };
                        
                        const addDiv = document.createElement('div');
                        addDiv.className = 'stock-photo-add';
                        
                        const addBtn = document.createElement('button');
                        addBtn.className = 'btn btn-success btn-sm';
                        addBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å';
                        addBtn.onclick = (e) => {
                            e.stopPropagation();
                            addPhotoFromUrl(img.url);
                        };
                        
                        addDiv.appendChild(addBtn);
                        imgDiv.appendChild(imgEl);
                        imgDiv.appendChild(addDiv);
                        stockGrid.appendChild(imgDiv);
                    });
                } else {
                    stockGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #ef4444;">‚ùå –°—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                stockGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #ef4444;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        function closeStockPhotos() {
            document.getElementById('stock-photos-section').style.display = 'none';
        }
        
        async function uploadPhotosFromComputer() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            const cardId = document.querySelector('.content-area').dataset.cardId;
            
            const button = fileInput.previousElementSibling;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                try {
                    const formData = new FormData();
                    formData.append('photo', file);
                    
                    const response = await fetch(`/photos/api/upload-photo-from-computer/${cardId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: formData,
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Error uploading photo:', data.error);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('Error uploading photo:', error);
                }
            }
            
            button.disabled = false;
            button.textContent = originalText;
            fileInput.value = '';
            
            if (successCount > 0) {
                if (errorCount > 0) {
                    alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${successCount}, –æ—à–∏–±–æ–∫: ${errorCount}`);
                }
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤.');
            }
        }
        
        async function addPhotoFromUrl(imageUrl) {
            const cardId = document.querySelector('.content-area').dataset.cardId;
            
            try {
                const response = await fetch(`/photos/api/add-photo-from-url/${cardId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: imageUrl }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function deletePhoto(photoId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/photos/api/delete-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const photoElement = document.getElementById(`photo-${photoId}`);
                    if (photoElement) {
                        photoElement.remove();
                    }
                    const photosGrid = document.querySelector('.photos-grid');
                    const photoCount = photosGrid.querySelectorAll('.photo-item').length;
                    const title = document.querySelector('.card-header h2');
                    if (title) {
                        title.textContent = `üì∏ –§–æ—Ç–æ (${photoCount})`;
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function setMainPhoto(photoId) {
            try {
                const response = await fetch(`/photos/api/set-main-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function enhancePhoto(photoId, mode = 'ghost_mannequin') {
            const photoElement = document.getElementById(`photo-${photoId}`);
            const img = photoElement ? photoElement.querySelector('img') : null;
            
            console.log(`üöÄ Starting enhancePhoto: photoId=${photoId}, mode=${mode}`);
            
            if (img) {
                img.style.opacity = '0.5';
                console.log('‚úÖ Set image opacity to 0.5');
            } else {
                console.warn('‚ö†Ô∏è Image element not found');
            }
            
            const modeText = mode === 'ghost_mannequin' ? '–ì–µ–Ω–µ—Ä–∏—Ä—É—é –º–æ–¥–µ–ª—å (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 —Å–µ–∫)' : '–£–ª—É—á—à–∞—é —Ñ–æ—Ç–æ';
            console.log(`${modeText} –¥–ª—è —Ñ–æ—Ç–æ ${photoId}...`);
            
            try {
                const url = `/photos/api/enhance-photo/${photoId}/`;
                console.log(`üì° Sending POST to: ${url}`);
                
                // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π timeout –¥–ª—è FASHN (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 150000); // 150 —Å–µ–∫—É–Ω–¥ = 2.5 –º–∏–Ω—É—Ç—ã
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode }),
                    signal: controller.signal
                }).finally(() => clearTimeout(timeoutId));
                
                console.log(`üì• Response status: ${response.status}`);
                
                const data = await response.json();
                console.log('üì• Response data:', data);
                
                if (data.success) {
                    console.log(`‚úÖ ${data.message}`);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
                    if (data.reload) {
                        console.log('üîÑ Reloading page...');
                        window.location.reload();
                    } else if (img) {
                        img.src = data.photo_url + '?t=' + Date.now();
                        img.style.opacity = '1';
                    }
                } else {
                    console.error('‚ùå Photoroom API error:', data.error);
                    alert(`‚ùå –û—à–∏–±–∫–∞ Photoroom:\n${data.error}\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
                    if (img) {
                        img.style.opacity = '1';
                    }
                }
            } catch (error) {
                console.error('‚ùå Exception in enhancePhoto:', error);
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:\n${error.message}\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
                if (img) {
                    img.style.opacity = '1';
                }
            }
        }
        
        async function rotatePhoto(photoId, direction = 'right') {
            const photoElement = document.getElementById(`photo-${photoId}`);
            const img = photoElement ? photoElement.querySelector('img') : null;
            
            if (img) {
                img.style.opacity = '0.5';
            }
            
            try {
                const response = await fetch(`/photos/api/rotate-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ direction: direction }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (img) {
                        img.src = data.photo_url + '?t=' + Date.now();
                        img.style.opacity = '1';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    if (img) {
                        img.style.opacity = '1';
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —Ñ–æ—Ç–æ: ' + error.message);
                if (img) {
                    img.style.opacity = '1';
                }
            }
        }
        
        async function searchByBarcode(barcode) {
            const resultsDiv = document.getElementById('search-results');
            const loadingDiv = document.getElementById('search-loading');
            const contentDiv = document.getElementById('search-content');
            
            resultsDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            contentDiv.innerHTML = '';
            
            try {
                // –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –ø–æ –±–∞—Ä–∫–æ–¥—É
                const response = await fetch('/photos/api/search-barcode/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ barcode: barcode }),
                });
                
                const data = await response.json();
                
                // –¢–∞–∫–∂–µ –∏—â–µ–º —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ –ø–æ –±–∞—Ä–∫–æ–¥—É
                const cardId = document.querySelector('.content-area').dataset.cardId;
                let stockPhotosHtml = '';
                
                try {
                    const stockResponse = await fetch(`/photos/api/search-stock-photos/${cardId}/?barcode=${encodeURIComponent(barcode)}`, {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                    });
                    
                    const stockData = await stockResponse.json();
                    
                    if (stockData.success && stockData.images && stockData.images.length > 0) {
                        stockPhotosHtml = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">';
                        stockPhotosHtml += '<h4 style="font-size: 13px; font-weight: 600; margin-bottom: 10px; color: #111827;">üì∑ –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ:</h4>';
                        stockPhotosHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">';
                        stockData.images.forEach(img => {
                            const imgUrl = img.thumbnail || img.url;
                            stockPhotosHtml += `<div style="position: relative; border-radius: 4px; overflow: hidden; border: 1px solid #e5e7eb; cursor: pointer;" onclick="addPhotoFromUrl('${img.url}')">`;
                            stockPhotosHtml += `<img src="${imgUrl}" style="width: 100%; height: 100px; object-fit: cover; display: block;" onerror="this.src='${img.url}'">`;
                            stockPhotosHtml += `<div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 4px; text-align: center; font-size: 10px; color: white;">+ –î–æ–±–∞–≤–∏—Ç—å</div>`;
                            stockPhotosHtml += '</div>';
                        });
                        stockPhotosHtml += '</div></div>';
                    }
                } catch (stockError) {
                    console.log('Stock photos search error:', stockError);
                }
                
                loadingDiv.style.display = 'none';
                
                if (data.success && data.results) {
                    let html = '<div style="background: white; padding: 12px; border-radius: 6px;">';
                    
                    if (data.results.title) {
                        html += `<h3 style="margin-bottom: 8px; font-size: 14px; color: #111827;">${data.results.title}</h3>`;
                    }
                    
                    if (data.results.description) {
                        html += `<p style="margin-bottom: 8px; font-size: 12px; color: #374151;">${data.results.description}</p>`;
                    }
                    
                    if (data.results.price) {
                        html += `<p style="margin-bottom: 8px; font-size: 13px; color: #059669; font-weight: 600;">–¶–µ–Ω–∞: $${data.results.price}</p>`;
                    }
                    
                    if (data.results.images && data.results.images.length > 0) {
                        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">';
                        html += '<h4 style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #111827;">üñºÔ∏è –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞:</h4>';
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">';
                        data.results.images.forEach(img => {
                            html += `<div style="position: relative; border-radius: 4px; overflow: hidden; border: 1px solid #e5e7eb; cursor: pointer;" onclick="addPhotoFromUrl('${img}')">`;
                            html += `<img src="${img}" style="width: 100%; height: 100px; object-fit: cover; display: block;">`;
                            html += `<div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 4px; text-align: center; font-size: 10px; color: white;">+ –î–æ–±–∞–≤–∏—Ç—å</div>`;
                            html += '</div>';
                        });
                        html += '</div></div>';
                    }
                    
                    html += stockPhotosHtml;
                    html += '</div>';
                    contentDiv.innerHTML = html;
                } else {
                    // –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–µ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
                    if (stockPhotosHtml) {
                        contentDiv.innerHTML = '<div style="background: white; padding: 12px; border-radius: 6px;"><p style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –Ω–æ –Ω–∞–π–¥–µ–Ω—ã —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ:</p>' + stockPhotosHtml + '</div>';
                    } else {
                        contentDiv.innerHTML = '<p style="color: #6b7280; font-size: 12px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    }
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                contentDiv.innerHTML = `<p style="color: #ef4444; font-size: 12px;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }
        
        function startVoiceInput(elementId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const element = document.getElementById(elementId);
            if (!element) {
                console.error('Element not found:', elementId);
                    return;
                }
                
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = true;
            
            const button = event.target;
            const originalText = button.textContent;
            
            recognition.onstart = () => {
                button.classList.add('recording');
                button.textContent = 'üé§ –ó–∞–ø–∏—Å—å...';
                button.disabled = true;
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (element.tagName === 'TEXTAREA') {
                    const currentValue = element.value;
                    const currentInterim = currentValue.match(/\[–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\]$/);
                    const baseValue = currentInterim ? currentValue.replace(/\[–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\]$/, '') : currentValue;
                    element.value = baseValue + finalTranscript + (interimTranscript ? interimTranscript + ' [–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç]' : '');
                } else {
                    element.value = finalTranscript + interimTranscript;
                }
                
                element.dispatchEvent(new Event('input', { bubbles: true }));
            };
            
            recognition.onend = () => {
                button.classList.remove('recording');
                button.textContent = originalText;
                button.disabled = false;
                
                if (element.tagName === 'TEXTAREA') {
                    element.value = element.value.replace(/\[–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\]$/, '');
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                button.classList.remove('recording');
                button.textContent = originalText;
                button.disabled = false;
                alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: ' + event.error);
            };
            
            function doStartVoiceInput() {
                try {
                    recognition.start();
                } catch (e) {
                    if (e.name === 'InvalidStateError') {
                        setTimeout(() => {
                            try {
                                recognition.stop();
                                setTimeout(() => recognition.start(), 100);
                            } catch (e2) {
                                console.error('Error restarting recognition:', e2);
                            }
                        }, 100);
                } else {
                        console.error('Error starting recognition:', e);
                    }
                }
            }
            
            doStartVoiceInput();
        }
        
        async function saveAISummary() {
            const cardId = document.querySelector('.content-area').dataset.cardId;
            const summaryContent = document.querySelector('#ai-summary-content');
            const summaryText = summaryContent ? summaryContent.value : '';
            
            if (!summaryText || summaryText.trim() === '') {
                alert('–°–≤–æ–¥–∫–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            try {
                const response = await fetch(`/photos/api/save-ai-summary/${cardId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ summary: summaryText }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –°–≤–æ–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–≤–æ–¥–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–≤–æ–¥–∫–∏: ' + error.message);
            }
        }
        
        async function generateSummary() {
            const cardId = document.querySelector('.content-area').dataset.cardId;
            const btn = document.getElementById('generate-summary-btn');
            const loadingDiv = document.getElementById('summary-loading');
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
            }
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }
            
            try {
                const response = await fetch(`/photos/api/generate-summary/${cardId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success && data.summary) {
                    console.log('‚úÖ Summary generated, applying to card fields...');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–≤–æ–¥–∫—É –∫ –ø–æ–ª—è–º
                    const summaryText = data.summary;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤)
                    if (summaryText.length < 50) {
                        console.error('Description too short:', summaryText);
                        window.location.reload();
                        return;
                    }
                    
                    const applied = await autoApplySummary(summaryText);
                    
                    if (applied && applied.length > 0) {
                        console.log(`‚úÖ Applied fields: ${applied.join(', ')}`);
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        const form = document.querySelector('.product-form');
                        if (form) {
                            form.submit();
                        }
                    } else {
                        console.error('Failed to extract data from summary');
                        window.location.reload();
                    }
                } else {
                    console.error('Generation failed:', data.error);
                    window.location.reload();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–∫–∏:', error);
                window.location.reload();
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞';
                }
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }
        }
        
        async function autoApplySummary(summaryText) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –∫ –ø–æ–ª—è–º (–±–µ–∑ alert –∏ —Å–∫—Ä–æ–ª–ª–∞)
            console.log('üìã Auto-applying summary, text length:', summaryText.length);
            
            let title = '';
            let description = '';
            let brand = '';
            let category = '';
            let size = '';
            let price = '';
            let color = '';
            let condition = '';
            
            // –ü–∞—Ä—Å–∏–º –≤—Å–µ –ø–æ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ –≤ applyAISummaryToCard)
            return parseSummaryAndFillFields(summaryText, true);
        }
        
        function parseSummaryAndFillFields(summaryText, silent = false) {
            if (!summaryText || summaryText.trim() === '') {
                if (!silent) alert('–°–≤–æ–¥–∫–∞ –ø—É—Å—Ç–∞');
                return null;
            }
            
            if (!silent) {
                console.log('üìã Applying summary, text length:', summaryText.length);
                console.log('üìã Summary preview:', summaryText.substring(0, 300));
            }
            
            let title = '';
            let description = '';
            let brand = '';
            let category = '';
            let size = '';
            let price = '';
            let color = '';
            let condition = '';
            
            // 1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: –∏–∑ "–ë—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å" –∏–ª–∏ –∏–∑ "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä" –∏–ª–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
            const brandMatch = summaryText.match(/\*\*–ë—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å:\*\*\s*(.+?)(?:\n\*\*|$)/i);
            if (brandMatch) {
                const brandModel = brandMatch[1].trim();
                title = brandModel;
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –±—Ä–µ–Ω–¥ (–ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ)
                const parts = brandModel.split(/\s+/);
                if (parts.length > 0) {
                    brand = parts[0];
                }
                console.log('‚úÖ Title from brand&model:', title);
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è, –ø—Ä–æ–±—É–µ–º –∏–∑ "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä"
            if (!title) {
                const whatMatch = summaryText.match(/\*\*–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä:\*\*\s*(.+?)(?:\n\*\*|$)/i);
                if (whatMatch) {
                    const whatText = whatMatch[1].trim();
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    title = whatText.split(/[\.\n]/)[0].trim();
                    console.log('‚úÖ Title from "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä":', title);
                }
            }
            
            // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è, –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
            if (!title) {
                const descMatch = summaryText.match(/\*\*–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:\*\*\s*([\s\S]+?)(?:\n\*\*|$)/i);
                if (descMatch) {
                    const descText = descMatch[1].trim();
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –±—Ä–µ–Ω–¥ –∏ —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
                    // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
                    const brandPatterns = [
                        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤
                        // "Stone Island" –≤ –Ω–∞—á–∞–ª–µ
                        /^(Stone Island|Tommy Hilfiger|Victoria's Secret|Calvin Klein|Ralph Lauren|Hugo Boss|Lacoste|Guess|Armani|Zara|H&M|XGO|Nike|Adidas|Puma|Reebok|Under Armour|The North Face|Patagonia|Columbia|Levi's|Wrangler|Lee|Gap|Old Navy|Banana Republic|J\.Crew)\s+(—á–µ—Ä–Ω\w+|–±–µ–ª\w+|—Å–∏–Ω\w+|–∫—Ä–∞—Å–Ω\w+|–∑–µ–ª–µ–Ω\w+|—Å–µ—Ä\w+|–∫–æ—Ä–∏—á–Ω–µ–≤\w+|–±–µ–∂–µ–≤\w+|—Ä–æ–∑–æ–≤\w+)?\s*(—Å–≤–∏—Ç–µ—Ä|—Ñ—É—Ç–±–æ–ª–∫–∞|–∫–æ—Ñ—Ç–∞|—Ö—É–¥–∏|—à—Ç–∞–Ω—ã|–±—Ä—é–∫–∏|–∫—É—Ä—Ç–∫–∞|—Ç–µ—Ä–º–æ–±–µ–ª—å–µ|—Ç—Ä—É—Å—ã|–±–µ–ª—å–µ|–¥–∂–∏–Ω—Å—ã|—à–æ—Ä—Ç—ã|–º–∞–π–∫–∞|—Ä—É–±–∞—à–∫–∞|–±–ª—É–∑–∫–∞|–ø–ª–∞—Ç—å–µ|—é–±–∫–∞)/i,
                        // "—á–µ—Ä–Ω—ã–π —Å–≤–∏—Ç–µ—Ä –æ—Ç Tommy Hilfiger"
                        /(—á–µ—Ä–Ω\w+|–±–µ–ª\w+|—Å–∏–Ω\w+|–∫—Ä–∞—Å–Ω\w+|–∑–µ–ª–µ–Ω\w+|—Å–µ—Ä\w+|–∫–æ—Ä–∏—á–Ω–µ–≤\w+|–±–µ–∂–µ–≤\w+|—Ä–æ–∑–æ–≤\w+)?\s*(—Å–≤–∏—Ç–µ—Ä|—Ñ—É—Ç–±–æ–ª–∫–∞|–∫–æ—Ñ—Ç–∞|—Ö—É–¥–∏|—à—Ç–∞–Ω—ã|–±—Ä—é–∫–∏|–∫—É—Ä—Ç–∫–∞|—Ç–µ—Ä–º–æ–±–µ–ª—å–µ|—Ç—Ä—É—Å—ã|–±–µ–ª—å–µ|—Ä—É–±–∞—à–∫–∞|–±–ª—É–∑–∫–∞)\s+–æ—Ç\s+(Stone Island|Tommy Hilfiger|Victoria's Secret|Calvin Klein|Ralph Lauren|Hugo Boss|Lacoste|Guess|Armani|Zara|H&M|XGO|Nike|Adidas|Puma)/i,
                        // "—Å–≤–∏—Ç–µ—Ä –æ—Ç Tommy Hilfiger"
                        /(—Å–≤–∏—Ç–µ—Ä|—Ñ—É—Ç–±–æ–ª–∫–∞|–∫–æ—Ñ—Ç–∞|—Ö—É–¥–∏|—à—Ç–∞–Ω—ã|–±—Ä—é–∫–∏|–∫—É—Ä—Ç–∫–∞|—Ç–µ—Ä–º–æ–±–µ–ª—å–µ|—Ç—Ä—É—Å—ã|–±–µ–ª—å–µ|—Ä—É–±–∞—à–∫–∞|–±–ª—É–∑–∫–∞)\s+–æ—Ç\s+(Stone Island|Tommy Hilfiger|Victoria's Secret|Calvin Klein|Ralph Lauren|Hugo Boss|Lacoste|Guess|Armani|Zara|H&M|XGO|Nike|Adidas|Puma|The North Face)/i,
                        // "—á–µ—Ä–Ω—ã–π —Å–≤–∏—Ç–µ—Ä"
                        /(—á–µ—Ä–Ω\w+|–±–µ–ª\w+|—Å–∏–Ω\w+|–∫—Ä–∞—Å–Ω\w+|–∑–µ–ª–µ–Ω\w+|—Å–µ—Ä\w+|–∫–æ—Ä–∏—á–Ω–µ–≤\w+|–±–µ–∂–µ–≤\w+|—Ä–æ–∑–æ–≤\w+)\s+(—Å–≤–∏—Ç–µ—Ä|—Ñ—É—Ç–±–æ–ª–∫–∞|–∫–æ—Ñ—Ç–∞|—Ö—É–¥–∏|—à—Ç–∞–Ω—ã|–±—Ä—é–∫–∏|–∫—É—Ä—Ç–∫–∞|—Ç–µ—Ä–º–æ–±–µ–ª—å–µ|—Ç—Ä—É—Å—ã|–±–µ–ª—å–µ|—Ä—É–±–∞—à–∫–∞|–±–ª—É–∑–∫–∞)/i
                    ];
                    
                    for (const pattern of brandPatterns) {
                        const match = descText.match(pattern);
                        if (match) {
                            if (match[3]) {
                                // –§–æ—Ä–º–∞—Ç: –ë—Ä–µ–Ω–¥ –¶–≤–µ—Ç –¢–æ–≤–∞—Ä (Stone Island —á–µ—Ä–Ω—ã–π —Å–≤–∏—Ç–µ—Ä)
                                const colorPart = match[2] ? ` ${match[2]}` : '';
                                title = `${match[3]}${colorPart} ${match[1]}`;
                                brand = match[3];
                            } else if (match[2] && match[1]) {
                                // –§–æ—Ä–º–∞—Ç: –¶–≤–µ—Ç –¢–æ–≤–∞—Ä –æ—Ç –ë—Ä–µ–Ω–¥ –∏–ª–∏ –¢–æ–≤–∞—Ä –æ—Ç –ë—Ä–µ–Ω–¥
                                if (match[3]) {
                                    title = `${match[3]} ${match[1]} ${match[2]}`;
                                    brand = match[3];
                                } else {
                                    title = `${match[1]} ${match[2]}`;
                                }
                            } else {
                                title = match[0];
                            }
                            console.log('‚úÖ Title extracted from description:', title);
                            break;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º, –∏–∑–≤–ª–µ–∫–∞–µ–º –±—Ä–µ–Ω–¥ –∏ —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
                    if (!title) {
                        // –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –≤ —Ç–µ–∫—Å—Ç–µ
                        const brandInText = descText.match(/(Stone Island|Victoria's Secret|XGO|Nike|Adidas|Puma|Under Armour|The North Face|Patagonia|Columbia)/i);
                        const itemType = descText.match(/(—Å–≤–∏—Ç–µ—Ä|—Ñ—É—Ç–±–æ–ª–∫–∞|–∫–æ—Ñ—Ç–∞|—Ö—É–¥–∏|—à—Ç–∞–Ω—ã|–±—Ä—é–∫–∏|–∫—É—Ä—Ç–∫–∞|—Ç–µ—Ä–º–æ–±–µ–ª—å–µ|—Ç—Ä—É—Å—ã|–±–µ–ª—å–µ|–¥–∂–∏–Ω—Å—ã|—à–æ—Ä—Ç—ã|–º–∞–π–∫–∞)/i);
                        const colorInText = descText.match(/(—á–µ—Ä–Ω\w+|–±–µ–ª\w+|—Å–∏–Ω\w+|–∫—Ä–∞—Å–Ω\w+|–∑–µ–ª–µ–Ω\w+|—Å–µ—Ä\w+|–∫–æ—Ä–∏—á–Ω–µ–≤\w+|–±–µ–∂–µ–≤\w+|—Ä–æ–∑–æ–≤\w+)/i);
                        
                        if (brandInText && itemType) {
                            brand = brandInText[1];
                            const itemWord = itemType[1];
                            const colorWord = colorInText ? colorInText[1] : '';
                            title = colorWord ? `${itemWord} ${colorWord} ${brand}` : `${itemWord} ${brand}`;
                            console.log('‚úÖ Title constructed from parts:', title);
                        } else if (itemType) {
                            const colorWord = colorInText ? colorInText[1] : '';
                            title = colorWord ? `${itemType[1]} ${colorWord}` : itemType[1];
                            console.log('‚úÖ Title from item type:', title);
                        } else {
                            // Fallback: –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3-5 —Å–ª–æ–≤
                            const words = descText.split(/\s+/).slice(0, 5).join(' ');
                            title = words.length > 50 ? words.substring(0, 50) : words;
                            console.log('‚úÖ Title from first words:', title);
                        }
                    }
                }
            }
            
            // 2. –†–∞–∑–º–µ—Ä: –∏–∑ "–†–∞–∑–º–µ—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" –∏–ª–∏ –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞ –≤ —Å–≤–æ–¥–∫–µ
            const sizeMatch = summaryText.match(/\*\*–†–∞–∑–º–µ—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:\*\*\s*(.+?)(?:\n\*\*|$)/i);
            if (sizeMatch) {
                const sizeText = sizeMatch[1].trim();
                // –ò—â–µ–º —Ä–∞–∑–º–µ—Ä: XS, S, M, L, XL, XXL –∏–ª–∏ —Ü–∏—Ñ—Ä—ã (38, 42, 10.5 –∏ —Ç.–¥.)
                const sizePatterns = [
                    /—Ä–∞–∑–º–µ—Ä[:\s]+([XSML]{1,3}|\d{1,2})/i,
                    /size[:\s]+([XSML]{1,3}|\d{1,2})/i,
                    /\b([XS]{1,2}|S|M|L|XL{1,2}|XXL)\b/i,
                    /\b(\d{1,2})\b/
                ];
                
                for (const pattern of sizePatterns) {
                    const found = sizeText.match(pattern);
                    if (found && found[1]) {
                        size = found[1].trim().toUpperCase();
                        console.log('‚úÖ Size found:', size);
                        break;
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
                if (!size) {
                    const sizeParts = sizeText.split(/[,;]/);
                    if (sizeParts.length > 0) {
                        const firstPart = sizeParts[0].trim();
                        const words = firstPart.split(/\s+/);
                        if (words.length > 0) {
                            size = words[0];
                            console.log('‚úÖ Size from first word:', size);
                        }
                    }
                }
            }
            
            // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –≤–æ –≤—Å–µ–π —Å–≤–æ–¥–∫–µ
            if (!size) {
                const allSizePatterns = [
                    /—Ä–∞–∑–º–µ—Ä[:\s]+([XSML]{1,3}|\d{1,2})/i,
                    /size[:\s]+([XSML]{1,3}|\d{1,2})/i,
                    /\b([XS]{1,2}|S|M|L|XL{1,2}|XXL)\b/i
                ];
                
                for (const pattern of allSizePatterns) {
                    const found = summaryText.match(pattern);
                    if (found && found[1]) {
                        size = found[1].trim().toUpperCase();
                        console.log('‚úÖ Size found in full summary:', size);
                        break;
                    }
                }
            }
            
            // 3. –¶–≤–µ—Ç: –∏–∑ "–¶–≤–µ—Ç:" –∏–ª–∏ –∏–∑ "–†–∞–∑–º–µ—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" –∏–ª–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
            console.log('üîç Searching for color...');
            const colorMatch = summaryText.match(/\*\*–¶–≤–µ—Ç:\*\*\s*([^\n]+?)(?:\n\*\*|$)/i);
            if (colorMatch) {
                const colorText = colorMatch[1].trim();
                console.log('Color section found:', colorText);
                if (colorText && !colorText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω') && !colorText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')) {
                    color = colorText;
                    console.log('‚úÖ Found color from section:', color);
                }
            }
            
            // –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
            if (!color && sizeMatch) {
                const sizeText = sizeMatch[1].trim();
                console.log('Checking size text for color:', sizeText.substring(0, 100));
                const colorPatterns = [
                    /—Ü–≤–µ—Ç[:\s]+([^,;.\n]+)/i,
                    /color[:\s]+([^,;.\n]+)/i,
                    /\b(–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π|—á–µ—Ä–Ω—ã–π|—Å–∏–Ω–∏–π|–±–µ–ª—ã–π|–∫—Ä–∞—Å–Ω—ã–π|–∑–µ–ª–µ–Ω—ã–π|–∂–µ–ª—Ç—ã–π|—Å–µ—Ä—ã–π|–±–µ–∂–µ–≤—ã–π|—Ä–æ–∑–æ–≤—ã–π|—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π|–æ—Ä–∞–Ω–∂–µ–≤—ã–π|–≥–æ–ª—É–±–æ–π|–±–∏—Ä—é–∑–æ–≤—ã–π|—Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π|—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π)\b/i
                ];
                
                for (const pattern of colorPatterns) {
                    const colorInText = sizeText.match(pattern);
                    if (colorInText) {
                        color = colorInText[1].trim();
                        console.log('‚úÖ Found color in characteristics:', color);
                        break;
                    }
                }
            }
            
            // –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –≤–æ –≤—Å–µ–π —Å–≤–æ–¥–∫–µ
            if (!color) {
                console.log('Searching for color in full summary...');
                
                // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —è–≤–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ü–≤–µ—Ç–∞
                const explicitColorPatterns = [
                    /—Ü–≤–µ—Ç[:\s]+([–∞-—è—ë\-]+)/i,
                    /color[:\s]+([a-z\-]+)/i,
                    /(—á–µ—Ä–Ω\w+|–±–µ–ª\w+|—Å–∏–Ω\w+|–∫—Ä–∞—Å–Ω\w+|–∑–µ–ª–µ–Ω\w+|—Å–µ—Ä\w+|–∫–æ—Ä–∏—á–Ω–µ–≤\w+|–±–µ–∂–µ–≤\w+|—Ä–æ–∑–æ–≤\w+|—Ñ–∏–æ–ª–µ—Ç–æ–≤\w+|–æ—Ä–∞–Ω–∂–µ–≤\w+|–≥–æ–ª—É–±\w+|–±–∏—Ä—é–∑–æ–≤\w+)\s+(—Å–≤–∏—Ç–µ—Ä|—Ñ—É—Ç–±–æ–ª–∫–∞|–∫–æ—Ñ—Ç–∞|—Ö—É–¥–∏|—à—Ç–∞–Ω—ã|–±—Ä—é–∫–∏|–∫—É—Ä—Ç–∫–∞|—Ç–µ—Ä–º–æ–±–µ–ª—å–µ|—Ç—Ä—É—Å—ã|–±–µ–ª—å–µ)/i
                ];
                
                for (const pattern of explicitColorPatterns) {
                    const match = summaryText.match(pattern);
                    if (match && match[1]) {
                        color = match[1].trim();
                        console.log('‚úÖ Found color by pattern:', color);
                        break;
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                if (!color) {
                    const colorKeywords = [
                        '—á–µ—Ä–Ω—ã–π', '–±–µ–ª—ã–π', '—Å–∏–Ω–∏–π', '–∫—Ä–∞—Å–Ω—ã–π', '–∑–µ–ª–µ–Ω—ã–π', '–∂–µ–ª—Ç—ã–π', 
                        '—Å–µ—Ä—ã–π', '–±–µ–∂–µ–≤—ã–π', '—Ä–æ–∑–æ–≤—ã–π', '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–æ—Ä–∞–Ω–∂–µ–≤—ã–π', '–≥–æ–ª—É–±–æ–π', '–±–∏—Ä—é–∑–æ–≤—ã–π',
                        '–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π', '—Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π', '—Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π',
                        'black', 'white', 'blue', 'red', 'green', 'yellow', 'gray', 'grey', 'beige', 'brown'
                    ];
                    
                    for (const keyword of colorKeywords) {
                        const regex = new RegExp(`\\b${keyword}\\b`, 'i');
                        if (summaryText.match(regex)) {
                            color = keyword;
                            console.log('‚úÖ Found color by keyword:', color);
                            break;
                        }
                    }
                }
            }
            
            if (!color) {
                console.warn('‚ùå Color not found in summary');
            }
            
            const conditionMatch = summaryText.match(/\*\*–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:\*\*\s*(.+?)(?:\n|$)/i);
            if (conditionMatch) {
                const conditionText = conditionMatch[1].trim().toLowerCase();
                if (conditionText.includes('new') || conditionText.includes('–Ω–æ–≤–æ–µ') || conditionText.includes('–Ω–æ–≤—ã–π')) {
                    condition = 'new';
                    console.log('‚úÖ Found condition: new');
                } else if (conditionText.includes('used') || conditionText.includes('–±/—É') || conditionText.includes('–±—ã–≤—à–∏–π –≤ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏')) {
                    condition = 'used';
                    console.log('‚úÖ Found condition: used');
                } else if (conditionText.includes('refurbished') || conditionText.includes('–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ')) {
                    condition = 'refurbished';
                    console.log('‚úÖ Found condition: refurbished');
                }
            }
            
            // 3. –û–ø–∏—Å–∞–Ω–∏–µ: –∏–∑ "–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏" (–≤—Å—ë –¥–æ –∫–æ–Ω—Ü–∞)
            const descMatch = summaryText.match(/\*\*–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:\*\*\s*([\s\S]+?)(?:\n*$)/i);
            if (descMatch && descMatch[1]) {
                description = descMatch[1].trim();
                description = description.replace(/^\s+|\s+$/g, '');
                description = description.replace(/^\n+|\n+$/g, '');
                console.log('‚úÖ Found description for sale, length:', description.length);
                console.log('Description preview:', description.substring(0, 100));
            } else {
                // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä" –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–∏–µ
                const whatMatch = summaryText.match(/\*\*–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä:\*\*\s*(.+?)(?:\n\*\*|$)/i);
                if (whatMatch) {
                    description = whatMatch[1].trim();
                    console.log('‚úÖ Using "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä" as description');
                } else {
                    console.warn('‚ö†Ô∏è Description not found in summary');
                    description = '';
                }
            }
            
            console.log('üîç Searching for price...');
            const priceSectionMatch = summaryText.match(/\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ \(USD\):\*\*\s*([\s\S]*?)(?:\n\*\*|$)/i);
            
            if (priceSectionMatch) {
                let priceText = priceSectionMatch[1].trim();
                console.log('Price section content:', priceText);
                
                if (!priceText || priceText === '' || /^\s*$/.test(priceText) || priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–∞') || priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')) {
                    const priceOnNextLine = summaryText.match(/\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ \(USD\):\*\*\s*\n\s*(\d+\.?\d*)/m);
                    if (priceOnNextLine) {
                        priceText = priceOnNextLine[1].trim();
                        console.log('‚úÖ Price found on next line:', priceText);
                    } else {
                        const priceAfterBlank = summaryText.match(/\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ \(USD\):\*\*\s*\n\s*\n\s*(\d+\.?\d*)/m);
                        if (priceAfterBlank) {
                            priceText = priceAfterBlank[1].trim();
                            console.log('‚úÖ Price found after blank line:', priceText);
                        }
                    }
                }
                
                if (priceText && !priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–∞') && !priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')) {
                    const numberMatch = priceText.match(/(\d+\.?\d*)/);
                    if (numberMatch) {
                        const cleanPriceText = numberMatch[1].replace(',', '.');
                        const priceNumber = parseFloat(cleanPriceText);
                        console.log('Parsed price number:', priceNumber);
                        if (!isNaN(priceNumber) && priceNumber > 0) {
                            const discountedPrice = priceNumber * 0.8;
                            price = discountedPrice.toFixed(2);
                            console.log(`‚úÖ Found price: ${priceNumber}, discounted (-20%): ${price}`);
                        } else {
                            console.warn('Price number is invalid:', cleanPriceText);
                        }
                    }
                } else {
                    console.log('‚ö†Ô∏è Price section says "not specified" or empty');
                }
            } else {
                console.warn('‚ö†Ô∏è Price section header not found');
            }
            
            if (!price) {
                console.log('Searching for price in full summary text...');
                const pricePatterns = [
                    /\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞[^\n]*(\d+\.?\d*)/i,
                    /\b(\d{2,3}(?:\.\d{2})?)\s*(USD|–¥–æ–ª–ª–∞—Ä|dollar)/i,
                    /USD[:\s]+(\d+\.?\d*)/i,
                    /(\d+\.?\d*)\s*USD/i,
                    /—Ü–µ–Ω–∞[:\s]+(\d+\.?\d*)/i,
                    /price[:\s]+(\d+\.?\d*)/i,
                    /\$\s*(\d+\.?\d*)/i,
                    /(\d+\.?\d*)\s*–¥–æ–ª–ª–∞—Ä/i
                ];
                for (const pattern of pricePatterns) {
                    const matches = summaryText.matchAll(new RegExp(pattern.source, pattern.flags + 'g'));
                    for (const match of matches) {
                        const priceNumber = parseFloat(match[1]);
                        console.log('Found potential price:', match[1], 'parsed:', priceNumber, 'context:', match[0]);
                        if (!isNaN(priceNumber) && priceNumber >= 10 && priceNumber < 10000) {
                            if (priceNumber < 13) {
                                console.log('Skipping - likely size code');
                                continue;
                            }
                            const discountedPrice = priceNumber * 0.8;
                            price = discountedPrice.toFixed(2);
                            console.log(`‚úÖ Found price by pattern: ${priceNumber}, discounted (-20%): ${price}`);
                            break;
                        }
                    }
                    if (price) break;
                }
                
                if (!price) {
                    console.warn('‚ùå Price not found in summary');
                }
            }
            
            // 4. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –∏–∑ "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä" –∏–ª–∏ –∏–∑ –≤—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const categoryMatch = summaryText.match(/\*\*–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä:\*\*\s*(.+?)(?:\n\*\*|$)/i);
            let categoryText = categoryMatch ? categoryMatch[1].toLowerCase() : summaryText.toLowerCase();
            
            console.log('Searching for category...');
            
            // –û–¥–µ–∂–¥–∞
            if (categoryText.includes('—Ç–µ—Ä–º–æ–±–µ–ª—å') || categoryText.includes('thermal') || categoryText.includes('base layer') || 
                categoryText.includes('—Ñ–ª–∏—Å') || categoryText.includes('fleece') || categoryText.includes('–æ–¥–µ–∂–¥–∞') || 
                categoryText.includes('—Ä—É–±–∞—à–∫–∞') || categoryText.includes('shirt') || categoryText.includes('–∫—É—Ä—Ç–∫–∞') ||
                categoryText.includes('jacket') || categoryText.includes('—à—Ç–∞–Ω—ã') || categoryText.includes('pants') ||
                categoryText.includes('—Ç—Ä—É—Å—ã') || categoryText.includes('underwear') || categoryText.includes('–±–µ–ª—å–µ') ||
                categoryText.includes('—Ñ—É—Ç–±–æ–ª–∫–∞') || categoryText.includes('t-shirt') || categoryText.includes('–∫–æ—Ñ—Ç–∞') ||
                categoryText.includes('sweater') || categoryText.includes('—Ö—É–¥–∏') || categoryText.includes('hoodie') ||
                categoryText.includes('–±—Ä—é–∫–∏') || categoryText.includes('trousers') || categoryText.includes('–¥–∂–∏–Ω—Å—ã') ||
                categoryText.includes('jeans') || categoryText.includes('—à–æ—Ä—Ç—ã') || categoryText.includes('shorts') ||
                categoryText.includes('—Å–≤–∏—Ç–µ—Ä')) {
                category = '–û–¥–µ–∂–¥–∞';
                console.log('‚úÖ Category set to: –û–¥–µ–∂–¥–∞');
            } 
            // –û–±—É–≤—å
            else if (categoryText.includes('–æ–±—É–≤—å') || categoryText.includes('shoe') || categoryText.includes('–±–æ—Ç–∏–Ω–∫–∏') ||
                      categoryText.includes('boots') || categoryText.includes('–∫—Ä–æ—Å—Å–æ–≤–∫–∏') || categoryText.includes('sneakers') ||
                      categoryText.includes('—Ç—É—Ñ–ª–∏') || categoryText.includes('slippers') || categoryText.includes('—Å–∞–ø–æ–≥–∏')) {
                category = '–û–±—É–≤—å';
                console.log('‚úÖ Category set to: –û–±—É–≤—å');
            } 
            // –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã
            else if (categoryText.includes('—Å—É–º–∫–∞') || categoryText.includes('bag') || categoryText.includes('—Ä—é–∫–∑–∞–∫') ||
                      categoryText.includes('backpack') || categoryText.includes('—à–∞—Ä—Ñ') || categoryText.includes('scarf') ||
                      categoryText.includes('—à–∞–ø–∫–∞') || categoryText.includes('hat') || categoryText.includes('–ø–µ—Ä—á–∞—Ç–∫–∏') ||
                      categoryText.includes('gloves') || categoryText.includes('–æ—á–∫–∏') || categoryText.includes('glasses')) {
                category = '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã';
                console.log('‚úÖ Category set to: –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã');
            }
            
            if (!category) {
                console.warn('‚ùå Category not found');
            }
            
            let applied = [];
            
            console.log('Extracted values:', { title, description: description.substring(0, 50), brand, size, price, category, color, condition });
            
            if (title) {
                const titleField = document.querySelector('input[name="title"]');
                if (titleField) {
                    titleField.value = title;
                    applied.push('–Ω–∞–∑–≤–∞–Ω–∏–µ');
                    console.log('‚úÖ Title applied:', title);
                } else {
                    console.warn('‚ùå Title field not found');
                }
            }
            
            if (description) {
                const descField = document.querySelector('textarea[name="description"]');
                if (descField) {
                    descField.value = description;
                    applied.push('–æ–ø–∏—Å–∞–Ω–∏–µ');
                    console.log('‚úÖ Description applied, length:', description.length);
                } else {
                    console.warn('‚ùå Description field not found');
                }
            }
            
            // –ï—Å–ª–∏ –±—Ä–µ–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
            if (!brand && title) {
                const brandInTitle = title.match(/(Stone Island|Tommy Hilfiger|Victoria's Secret|Calvin Klein|Ralph Lauren|Hugo Boss|Lacoste|Guess|Armani|Zara|H&M|XGO|Nike|Adidas|Puma|Reebok|Under Armour|The North Face|Patagonia|Columbia|Levi's|Wrangler|Lee|Gap|Old Navy|Banana Republic|J\.Crew)/i);
                if (brandInTitle) {
                    brand = brandInTitle[1];
                    console.log('‚úÖ Brand extracted from title:', brand);
                }
            }
            
            // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ—Ç, –∏—â–µ–º –≤–æ –≤—Å–µ–π —Å–≤–æ–¥–∫–µ
            if (!brand) {
                const brandInSummary = summaryText.match(/(Stone Island|Tommy Hilfiger|Victoria's Secret|Calvin Klein|Ralph Lauren|Hugo Boss|Lacoste|Guess|Armani|Zara|H&M|XGO|Nike|Adidas|Puma|Reebok|Under Armour|The North Face|Patagonia|Columbia|Levi's|Wrangler|Lee|Gap|Old Navy|Banana Republic|J\.Crew)/i);
                if (brandInSummary) {
                    brand = brandInSummary[1];
                    console.log('‚úÖ Brand found in summary:', brand);
                }
            }
            
            if (brand) {
                const brandField = document.querySelector('input[name="brand"]');
                if (brandField) {
                    brandField.value = brand;
                    applied.push('–±—Ä–µ–Ω–¥');
                    console.log('‚úÖ Brand applied:', brand);
                } else {
                    console.warn('‚ùå Brand field not found');
                }
            }
            
            if (size) {
                const sizeField = document.querySelector('input[name="size"]');
                if (sizeField) {
                    sizeField.value = size;
                    applied.push('—Ä–∞–∑–º–µ—Ä');
                    console.log('‚úÖ Size applied:', size);
                } else {
                    console.warn('‚ùå Size field not found');
                }
            }
            
            if (price) {
                const priceField = document.querySelector('input[name="price"]');
                if (priceField) {
                    priceField.value = price;
                    applied.push(`—Ü–µ–Ω–∞ (${price} USD)`);
                    console.log('‚úÖ Price applied:', price);
                } else {
                    console.warn('‚ùå Price field not found');
                }
            }
            
            if (category) {
                const catField = document.querySelector('input[name="category"]');
                if (catField) {
                    catField.value = category;
                    applied.push('–∫–∞—Ç–µ–≥–æ—Ä–∏—è');
                    console.log('‚úÖ Category applied:', category);
                } else {
                    console.warn('‚ùå Category field not found');
                }
            }
            
            if (color) {
                const colorField = document.querySelector('input[name="color"]');
                if (colorField) {
                    colorField.value = color;
                    applied.push('—Ü–≤–µ—Ç');
                    console.log('‚úÖ Color applied:', color);
                } else {
                    console.warn('‚ùå Color field not found');
                }
            }
            
            if (condition) {
                const conditionField = document.querySelector('select[name="condition"]');
                if (conditionField) {
                    conditionField.value = condition;
                    applied.push('—Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                    console.log('‚úÖ Condition applied:', condition);
                } else {
                    console.warn('‚ùå Condition field not found');
                }
            }
            
            if (applied.length > 0) {
                console.log(`‚úÖ –°–≤–æ–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞! –ó–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è: ${applied.join(', ')}`);
                if (!silent) {
                    document.querySelector('.product-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                return applied;
            } else {
                console.error('‚ùå No fields were applied. Summary text:', summaryText.substring(0, 200));
                return null;
            }
        }
        
        function applyAISummaryToCard() {
            const summaryDiv = document.querySelector('.ai-summary-section');
            if (!summaryDiv) {
                alert('–°–≤–æ–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const summaryContent = document.querySelector('#ai-summary-content');
            const summaryText = summaryContent ? (summaryContent.tagName === 'TEXTAREA' ? summaryContent.value : (summaryContent.textContent || summaryContent.innerText)) : '';
            
            parseSummaryAndFillFields(summaryText, false);
        }
    </script>
</body>
</html>
