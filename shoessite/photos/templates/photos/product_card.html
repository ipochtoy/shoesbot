{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ {{ card.correlation_id }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }
        .header-top {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .header h1 {
            font-size: 24px;
            flex-grow: 1;
            margin: 0;
            word-break: break-word;
            min-width: 0;
        }
        .header .meta {
            font-size: 14px;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .photos-section {
            margin-bottom: 30px;
        }
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .photo-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .photo-barcodes {
            padding: 10px;
            background: #f9f9f9;
            font-size: 12px;
        }
        .barcodes-section {
            margin-bottom: 30px;
        }
        .barcodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .barcode-item {
            padding: 12px;
            background: #f0f0f0;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .barcode-item.gg-label {
            border-left-color: #e74c3c;
            background: #ffe6e6;
        }
        .barcode-item .symbology {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        .barcode-item .data {
            font-size: 18px;
            font-family: monospace;
            margin: 5px 0;
        }
        .barcode-item .source {
            font-size: 12px;
            color: #888;
        }
        .gg-labels-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        .gg-labels-section h3 {
            margin-bottom: 10px;
            color: #856404;
        }
        .gg-labels-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .gg-label {
            padding: 8px 15px;
            background: white;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #ffc107;
        }
        .product-form {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .section-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            cursor: pointer;
        }
        .lightbox-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-reprocess:hover {
            background: #c0392b !important;
        }
        .processing {
            opacity: 0.6;
            pointer-events: none;
        }
        .ai-suggestions-box {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
        }
        .ai-suggestions-box h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .ai-field {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .ai-field label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        .ai-field input,
        .ai-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .ai-field textarea {
            min-height: 80px;
            resize: vertical;
        }
        .voice-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .voice-btn:hover {
            background: #8e44ad;
        }
        .voice-btn.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .apply-all-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 15px;
        }
        .apply-all-btn:hover {
            background: #229954;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <a href="/admin/photos/photobatch/" class="back-button">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤</a>
            <h1>{{ card.title|default:card.correlation_id }}</h1>
            </div>
            <div class="meta">
                ID: {{ card.correlation_id }} | 
                –°—Ç–∞—Ç—É—Å: {{ card.get_status_display }} | 
                –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ card.uploaded_at|date:"d.m.Y H:i" }}
            </div>
        </div>
        
        <div class="content" data-card-id="{{ card.id }}">
            <div class="photos-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="section-title">üì∏ –§–æ—Ç–æ ({{ photos|length }})</h2>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="document.getElementById('file-input').click()" 
                                style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                        <input type="file" id="file-input" multiple accept="image/*" style="display: none;" onchange="uploadPhotosFromComputer()">
                        <button type="button" onclick="searchStockPhotos()" 
                                style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîç –ù–∞–π—Ç–∏ —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ
                        </button>
                    </div>
                </div>
                <div class="photos-grid">
                    {% for photo in photos %}
                    <div class="photo-item" id="photo-{{ photo.id }}" style="position: relative; {% if photo.is_main %}border: 3px solid #f39c12; box-shadow: 0 0 10px rgba(243, 156, 18, 0.5);{% endif %}">
                        {% if photo.is_main %}
                        <div style="position: absolute; top: 5px; left: 5px; background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; z-index: 11;">
                            ‚≠ê –ì–ª–∞–≤–Ω–æ–µ
                        </div>
                        {% endif %}
                        <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10; flex-wrap: wrap; max-width: 100px;">
                            <button type="button" onclick="setMainPhoto({{ photo.id }})" 
                                    title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω–æ–π"
                                    style="padding: 4px 8px; background: rgba(243,156,18,0.9); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ‚≠ê
                            </button>
                            <button type="button" onclick="rotatePhoto({{ photo.id }}, 'left')" 
                                    title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ª–µ–≤–æ (90¬∞)"
                                    style="padding: 4px 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ‚Ü∂
                            </button>
                            <button type="button" onclick="rotatePhoto({{ photo.id }}, 'right')" 
                                    title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ø—Ä–∞–≤–æ (90¬∞)"
                                    style="padding: 4px 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ‚Ü∑
                            </button>
                            <button type="button" onclick="deletePhoto({{ photo.id }})" 
                                    title="–£–¥–∞–ª–∏—Ç—å"
                                    style="padding: 4px 8px; background: rgba(231,76,60,0.9); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ‚úï
                            </button>
                        </div>
                        <img src="{{ photo.image.url }}" alt="–§–æ—Ç–æ {{ photo.id }}" 
                             onclick="openLightbox('{{ photo.image.url }}')" 
                             style="cursor: pointer; width: 100%; height: auto;">
                        <div class="photo-barcodes">
                            –ö–æ–¥–æ–≤: {{ photo.barcodes.count }}
                            <button type="button" onclick="reprocessPhoto({{ photo.id }})" 
                                    class="btn-reprocess" 
                                    style="margin-top: 8px; padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                                üîç –ü—Ä–æ—á–µ—Å—Ç—å –∫–æ–¥—ã –µ—â–µ —Ä–∞–∑
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å—Ç–æ–∫–æ–≤—ã—Ö —Ñ–æ—Ç–æ -->
                <div id="stock-photos-section" style="display: none; margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 18px;">üì∑ –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ</h3>
                        <button type="button" onclick="closeStockPhotos()" 
                                style="padding: 6px 12px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ‚úï –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                    <div id="stock-photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ -->
                    </div>
                </div>
            </div>
            
            <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫ –±–∞—Ä–∫–æ–¥–æ–≤ –∏ GG –ª–µ–π–± -->
            <div style="background: #f9f9f9; padding: 10px 15px; border-radius: 8px; margin-top: 20px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <span style="font-size: 14px; color: #2c3e50; font-weight: bold;">üìä –ë–∞—Ä–∫–æ–¥—ã ({{ all_barcodes|length }}):</span>
                    
                    {% if all_barcodes %}
                    {% for barcode in all_barcodes %}
                    <div style="display: inline-flex; align-items: center; gap: 6px;">
                        <button type="button" onclick="searchByBarcode('{{ barcode.data }}')" 
                                style="background: #27ae60; padding: 4px 10px; font-size: 11px; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                            üîç {{ barcode.data }}
                    </button>
                        <span style="padding: 4px 8px; background: {% if barcode.source == 'gg-label' or barcode.data|slice:':1' == 'Q' %}#ffe6e6{% else %}#e8f4f8{% endif %}; border-radius: 4px; font-size: 11px; border-left: 2px solid {% if barcode.source == 'gg-label' or barcode.data|slice:':1' == 'Q' %}#e74c3c{% else %}#3498db{% endif %}; white-space: nowrap;">
                            <span style="font-weight: bold; color: #555;">{{ barcode.data }}</span>
                            <span style="color: #888; margin-left: 4px;">‚Ä¢ {{ barcode.symbology }}</span>
                        </span>
                </div>
                    {% endfor %}
                {% endif %}
                
                    {% if gg_labels %}
                    <span style="margin-left: auto; font-size: 12px; color: #856404; font-weight: bold;">üè∑Ô∏è GG:</span>
                    {% for gg in gg_labels %}
                    <span style="padding: 3px 8px; background: #fff3cd; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid #ffc107; white-space: nowrap;">{{ gg }}</span>
                        {% endfor %}
                    {% endif %}
                    </div>
                
                <div id="search-results" style="display: none; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px;">
                        <div id="search-loading" style="display: none;">–ü–æ–∏—Å–∫...</div>
                        <div id="search-content"></div>
                </div>
            </div>
            
            <div class="ai-summary-section" style="background: #e8f5e9; padding: 25px; border-radius: 8px; margin-top: 30px; margin-bottom: 30px; border-left: 4px solid #4caf50;">
                <h2 class="section-title" style="color: #2c3e50; margin-bottom: 15px;">
                    ü§ñ –°–≤–æ–¥–∫–∞ –æ—Ç OpenAI
                </h2>
                
                {% if ai_summary %}
                <div style="background: white; padding: 20px; border-radius: 6px; margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">üìù –°–≤–æ–¥–∫–∞ (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):</label>
                    <textarea id="ai-summary-content" 
                              style="width: 100%; min-height: 300px; padding: 15px; border: 2px solid #ddd; border-radius: 6px; line-height: 1.8; color: #333; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; resize: vertical;"
                              placeholder="–°–≤–æ–¥–∫–∞ –æ—Ç OpenAI...">{{ ai_summary }}</textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="voice-btn" onclick="startVoiceInput('ai-summary-content', event)" 
                                style="background: #9b59b6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            üé§ –î–∏–∫—Ç–æ–≤–∞—Ç—å
                        </button>
                        <span style="color: #666; font-size: 12px;">–ù–∞–∂–º–∏ üé§ —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É –≥–æ–ª–æ—Å–æ–º</span>
                    </div>
                </div>
                <button type="button" onclick="applyAISummaryToCard()" 
                        style="margin-top: 15px; padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px;">
                    ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–¥–∫—É –∫ –∫–∞—Ä—Ç–æ—á–∫–µ
                </button>
                {% else %}
                <div style="background: white; padding: 20px; border-radius: 6px; text-align: center; color: #666;">
                    <p style="margin-bottom: 15px;">–°–≤–æ–¥–∫–∞ –µ—â–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –µ—ë.</p>
                    <button type="button" onclick="generateSummary()" id="generate-summary-btn"
                            style="padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px;">
                        ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É
                    </button>
                    <div id="summary-loading" style="display: none; margin-top: 15px; padding: 15px; background: #f0f0f0; border-radius: 6px;">
                        <p>‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–≤–æ–¥–∫—É... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            
            <form method="post" class="product-form">
                {% csrf_token %}
                <h2 class="section-title">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <input type="text" name="title" value="{{ card.title }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                </div>
                <div class="form-group" style="width: 100%;">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" style="width: 100%; min-height: 200px;">{{ card.description }}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞</label>
                        <input type="number" name="price" step="0.01" value="{{ card.price }}" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                        <select name="condition">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                            <option value="new" {% if card.condition == 'new' %}selected{% endif %}>–ù–æ–≤–æ–µ</option>
                            <option value="used" {% if card.condition == 'used' %}selected{% endif %}>–ë/—É</option>
                            <option value="refurbished" {% if card.condition == 'refurbished' %}selected{% endif %}>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <input type="text" name="category" value="{{ card.category }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±—É–≤—å, –û–¥–µ–∂–¥–∞">
                    </div>
                    <div class="form-group">
                        <label>–ë—Ä–µ–Ω–¥</label>
                        <input type="text" name="brand" value="{{ card.brand }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä</label>
                        <input type="text" name="size" value="{{ card.size }}" placeholder="–†–∞–∑–º–µ—Ä">
                    </div>
                    <div class="form-group">
                        <label>–¶–≤–µ—Ç</label>
                        <input type="text" name="color" value="{{ card.color }}" placeholder="–¶–≤–µ—Ç">
                    </div>
                </div>
                <div class="form-group">
                    <label>SKU/–ê—Ä—Ç–∏–∫—É–ª</label>
                    <input type="text" name="sku" value="{{ card.sku }}" placeholder="–ê—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞">
                </div>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
            
        </div>
    </div>
    
    <!-- Lightbox –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
        <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="–§–æ—Ç–æ">
        </div>
    </div>
    
    <script>
        function openLightbox(imgSrc) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = imgSrc;
            lightbox.style.display = 'block';
        }
        
        function closeLightbox(event) {
            if (event) {
                event.stopPropagation();
            }
            document.getElementById('lightbox').style.display = 'none';
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLightbox();
            }
        });
        
        async function reprocessPhoto(photoId) {
            const btn = event.target;
            const photoItem = btn.closest('.photo-item');
            
            if (confirm('–ü–µ—Ä–µ—á–∏—Ç–∞—Ç—å –∫–æ–¥—ã —Å —ç—Ç–æ–≥–æ —Ñ–æ—Ç–æ? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.')) {
                photoItem.classList.add('processing');
                btn.disabled = true;
                btn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                
                try {
                    const response = await fetch(`/photos/api/reprocess-photo/${photoId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        let message = '';
                        if (data.barcodes_found > 0) {
                            message = `‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤: ${data.barcodes_found}\n\n–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–¥—ã:\n${data.barcodes.join('\n')}`;
                        } else {
                            message = `‚ÑπÔ∏è –ù–æ–≤—ã—Ö –∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${data.total_results || 0}`;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± API
                        if (data.api_info) {
                            message += `\n\nüì° –°—Ç–∞—Ç—É—Å API:\n${data.api_info.join('\n')}`;
                        }
                        
                        if (data.debug_info) {
                            message += `\n\nüîç –û—Ç–ª–∞–¥–∫–∞:\n`;
                            message += `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: ${data.debug_info.used_pipeline || 'unknown'}\n`;
                            message += `Google Vision: ${data.debug_info.google_vision_called ? '–≤—ã–∑–≤–∞–Ω' : '–Ω–µ –≤—ã–∑–≤–∞–Ω'}\n`;
                            message += `OpenAI: ${data.debug_info.openai_called ? '–≤—ã–∑–≤–∞–Ω' : '–Ω–µ –≤—ã–∑–≤–∞–Ω'}`;
                        }
                        
                        alert(message);
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                        window.location.reload();
                    } else {
                        let errorMsg = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                        if (data.traceback) {
                            console.error('Traceback:', data.traceback);
                            errorMsg += '\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.';
                        }
                        alert(errorMsg);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: ' + error.message);
                } finally {
                    photoItem.classList.remove('processing');
                    btn.disabled = false;
                    btn.textContent = 'üîç –ü—Ä–æ—á–µ—Å—Ç—å –∫–æ–¥—ã –µ—â–µ —Ä–∞–∑';
                }
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        async function searchStockPhotos() {
            const cardId = document.querySelector('.content').dataset.cardId;
            const stockSection = document.getElementById('stock-photos-section');
            const stockGrid = document.getElementById('stock-photos-grid');
            
            stockSection.style.display = 'block';
            stockGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">üîç –ò—â—É —Å—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ...</div>';
            
            try {
                const response = await fetch(`/photos/api/search-stock-photos/${cardId}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                });
                
                const data = await response.json();
                
                if (data.success && data.images && data.images.length > 0) {
                    stockGrid.innerHTML = '';
                    data.images.forEach((img, index) => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = 'position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s;';
                        imgDiv.onmouseover = () => imgDiv.style.transform = 'scale(1.05)';
                        imgDiv.onmouseout = () => imgDiv.style.transform = 'scale(1)';
                        
                        const imgEl = document.createElement('img');
                        imgEl.src = img.thumbnail || img.url;
                        imgEl.style.cssText = 'width: 100%; height: 150px; object-fit: cover; display: block;';
                        imgEl.onerror = function() {
                            this.src = img.url;
                        };
                        
                        const btnDiv = document.createElement('div');
                        btnDiv.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 8px; text-align: center;';
                        
                        const addBtn = document.createElement('button');
                        addBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å';
                        addBtn.style.cssText = 'padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
                        addBtn.onclick = (e) => {
                            e.stopPropagation();
                            addPhotoFromUrl(img.url);
                        };
                        
                        btnDiv.appendChild(addBtn);
                        imgDiv.appendChild(imgEl);
                        imgDiv.appendChild(btnDiv);
                        stockGrid.appendChild(imgDiv);
                    });
                } else {
                    stockGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #e74c3c;">‚ùå –°—Ç–æ–∫–æ–≤—ã–µ —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                stockGrid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        function closeStockPhotos() {
            document.getElementById('stock-photos-section').style.display = 'none';
        }
        
        async function uploadPhotosFromComputer() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            const cardId = document.querySelector('.content').dataset.cardId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const button = fileInput.previousElementSibling;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞—é...';
            
            let successCount = 0;
            let errorCount = 0;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                try {
                    const formData = new FormData();
                    formData.append('photo', file);
                    
                    const response = await fetch(`/photos/api/upload-photo-from-computer/${cardId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: formData,
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Error uploading photo:', data.error);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('Error uploading photo:', error);
                }
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.disabled = false;
            button.textContent = originalText;
            
            // –û—á–∏—â–∞–µ–º input
            fileInput.value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (successCount > 0) {
                if (errorCount > 0) {
                    alert(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${successCount}, –æ—à–∏–±–æ–∫: ${errorCount}`);
                }
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –∏ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤.');
            }
        }
        
        async function addPhotoFromUrl(imageUrl) {
            const cardId = document.querySelector('.content').dataset.cardId;
            
            try {
                const response = await fetch(`/photos/api/add-photo-from-url/${cardId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: imageUrl }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function deletePhoto(photoId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/photos/api/delete-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                    const photoElement = document.getElementById(`photo-${photoId}`);
                    if (photoElement) {
                        photoElement.remove();
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ
                    const photosGrid = document.querySelector('.photos-grid');
                    const photoCount = photosGrid.querySelectorAll('.photo-item').length;
                    const title = document.querySelector('.photos-section .section-title');
                    if (title) {
                        title.textContent = `üì∏ –§–æ—Ç–æ (${photoCount})`;
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function setMainPhoto(photoId) {
            try {
                const response = await fetch(`/photos/api/set-main-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function movePhoto(photoId, direction) {
            try {
                const response = await fetch(`/photos/api/move-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ direction: direction }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function rotatePhoto(photoId, direction = 'right') {
            const photoElement = document.getElementById(`photo-${photoId}`);
            const img = photoElement ? photoElement.querySelector('img') : null;
            
            if (img) {
                img.style.opacity = '0.5';
            }
            
            try {
                const response = await fetch(`/photos/api/rotate-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ direction: direction }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º src –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å timestamp –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞
                    if (img) {
                        img.src = data.photo_url + '?t=' + Date.now();
                        img.style.opacity = '1';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    if (img) {
                        img.style.opacity = '1';
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —Ñ–æ—Ç–æ: ' + error.message);
                if (img) {
                    img.style.opacity = '1';
                }
            }
        }
        
        async function searchByBarcode(barcode) {
            const resultsDiv = document.getElementById('search-results');
            const loadingDiv = document.getElementById('search-loading');
            const contentDiv = document.getElementById('search-content');
            
            resultsDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            contentDiv.innerHTML = '';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º card_id –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ —Å —ç—Ç–∏–º –±–∞—Ä–∫–æ–¥–æ–º
                const contentDiv = document.querySelector('.content');
                const cardId = contentDiv ? contentDiv.getAttribute('data-card-id') : '';
                const url = `/photos/api/search-barcode/?barcode=${encodeURIComponent(barcode)}${cardId ? '&card_id=' + cardId : ''}`;
                
                console.log('Searching with Google Lens for barcode:', barcode);
                const response = await fetch(url);
                const data = await response.json();
                
                loadingDiv.style.display = 'none';
                
                if (data.error) {
                    contentDiv.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞: ${data.error}</p>`;
                    return;
                }
                
                let html = `<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è: <code>${barcode}</code></h4>`;
                
                if (data.title) {
                    html += `<div style="margin: 10px 0;">
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> 
                        <input type="text" value="${data.title}" id="found-title" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>`;
                }
                
                if (data.description) {
                    html += `<div style="margin: 10px 0;">
                        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
                        <textarea id="found-description" style="width: 100%; padding: 8px; margin-top: 5px; min-height: 100px;">${data.description}</textarea>
                    </div>`;
                }
                
                if (data.images && data.images.length > 0) {
                    html += `<div style="margin: 10px 0;">
                        <strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ (${data.images.length}):</strong>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">`;
                    data.images.slice(0, 6).forEach((img, idx) => {
                        html += `<img src="${img}" style="width: 100%; height: 150px; object-fit: cover; border: 2px solid #ddd; border-radius: 4px; cursor: pointer;" 
                                     onclick="window.open('${img}', '_blank')" 
                                     title="–ö–ª–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞">`;
                    });
                    html += `</div></div>`;
                }
                
                if (data.category) {
                    html += `<div style="margin: 10px 0;">
                        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> 
                        <input type="text" value="${data.category}" id="found-category" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>`;
                }
                
                if (data.brand) {
                    html += `<div style="margin: 10px 0;">
                        <strong>–ë—Ä–µ–Ω–¥:</strong> 
                        <input type="text" value="${data.brand}" id="found-brand" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>`;
                }
                
                if (data.price) {
                    html += `<div style="margin: 10px 0;">
                        <strong>–¶–µ–Ω–∞ ($):</strong> 
                        <input type="number" step="0.01" value="${data.price}" id="found-price" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>`;
                }
                
                if (data.title || data.description || data.category || data.brand || (data.images && data.images.length > 0)) {
                    html += `<button type="button" onclick="applySearchResults()" 
                                     style="margin-top: 15px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </button>`;
                } else {
                    html += `<p style="color: #999; padding: 20px; text-align: center;">–ü–æ —ç—Ç–æ–º—É –±–∞—Ä–∫–æ–¥—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –±–∞—Ä–∫–æ–¥ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É –≤—Ä—É—á–Ω—É—é.</p>`;
                }
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                contentDiv.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }
        
        function applySearchResults() {
            const titleInput = document.getElementById('found-title');
            const descInput = document.getElementById('found-description');
            const categoryInput = document.getElementById('found-category');
            const brandInput = document.getElementById('found-brand');
            const priceInput = document.getElementById('found-price');
            
            let applied = [];
            
            if (titleInput && titleInput.value) {
                document.querySelector('input[name="title"]').value = titleInput.value;
                applied.push('–Ω–∞–∑–≤–∞–Ω–∏–µ');
            }
            if (descInput && descInput.value) {
                document.querySelector('textarea[name="description"]').value = descInput.value;
                applied.push('–æ–ø–∏—Å–∞–Ω–∏–µ');
            }
            if (categoryInput && categoryInput.value) {
                document.querySelector('input[name="category"]').value = categoryInput.value;
                applied.push('–∫–∞—Ç–µ–≥–æ—Ä–∏—è');
            }
            if (brandInput && brandInput.value) {
                document.querySelector('input[name="brand"]').value = brandInput.value;
                applied.push('–±—Ä–µ–Ω–¥');
            }
            if (priceInput && priceInput.value) {
                document.querySelector('input[name="price"]').value = priceInput.value;
                applied.push('—Ü–µ–Ω–∞');
            }
            
            if (applied.length > 0) {
                alert(`‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è: ${applied.join(', ')}. –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.`);
            } else {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.');
            }
        }
        
        let recognition = null;
        let currentVoiceField = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Speech API
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = false;
            recognition.interimResults = true; // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
            
            recognition.onresult = function(event) {
                let newFinalTranscript = '';
                let interimTranscript = '';
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞—á–∏–Ω–∞—è —Å event.resultIndex
                // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        // –≠—Ç–æ –Ω–æ–≤—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                        newFinalTranscript += (newFinalTranscript ? ' ' : '') + transcript;
                    } else if (i === event.results.length - 1) {
                        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å–∞–º—ã–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π)
                        interimTranscript = transcript;
                    }
                }
                
                if (currentVoiceField) {
                    const field = document.getElementById(currentVoiceField);
                    if (field) {
                        if (field.tagName === 'TEXTAREA') {
                            // –î–ª—è textarea –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                            if (newFinalTranscript) {
                                const currentValue = field.value.trim();
                                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
                                const cleanValue = currentValue.replace(/\s*\[—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ\.\.\.\].*$/, '');
                                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
                                field.value = cleanValue + (cleanValue ? ' ' : '') + newFinalTranscript;
                            } else if (interimTranscript) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –º–µ—Ç–∫–æ–π
                                const currentValue = field.value.trim();
                                const cleanValue = currentValue.replace(/\s*\[—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ\.\.\.\].*$/, '');
                                field.value = cleanValue + (cleanValue ? ' ' : '') + '[—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ...] ' + interimTranscript;
                            }
                        } else {
                            // –î–ª—è input –∑–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
                            if (newFinalTranscript) {
                                field.value = newFinalTranscript;
                            } else if (interimTranscript) {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                                field.value = interimTranscript;
                            }
                        }
                        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ input –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        field.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                if (newFinalTranscript) {
                    stopVoiceInput();
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopVoiceInput();
                if (event.error === 'no-speech') {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: ' + event.error);
                }
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                // –ù–µ –æ—á–∏—â–∞–µ–º currentVoiceField —Å—Ä–∞–∑—É, –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                setTimeout(() => {
                    stopVoiceInput();
                }, 100);
            };
            
            recognition.onstart = function() {
                console.log('Speech recognition started');
            };
        }
        
        function startVoiceInput(fieldId, evt) {
            if (!recognition) {
                alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                return;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (currentVoiceField) {
                try {
                    recognition.stop();
                } catch (e) {
                    // –£–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                }
                // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º
                setTimeout(() => {
                    doStartVoiceInput(fieldId, evt);
                }, 200);
            } else {
                doStartVoiceInput(fieldId, evt);
            }
        }
        
        function doStartVoiceInput(fieldId, evt) {
            currentVoiceField = fieldId;
            const btn = evt ? evt.target : document.querySelector(`[onclick*="${fieldId}"]`);
            if (btn) {
                btn.classList.add('recording');
                btn.textContent = 'üî¥ –ó–∞–ø–∏—Å—å...';
            }
            
            try {
                recognition.start();
                console.log('Started voice input for field:', fieldId);
            } catch (e) {
                console.error('Error starting recognition:', e);
                // –ï—Å–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
                if (e.message && (e.message.includes('already started') || e.name === 'InvalidStateError')) {
                    try {
                        recognition.stop();
                    } catch (stopErr) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    }
                    setTimeout(() => {
                        try {
                            recognition.start();
                            console.log('Restarted voice input after error');
                        } catch (retryErr) {
                            console.error('Failed to restart:', retryErr);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.');
                            stopVoiceInput();
                        }
                    }, 300);
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + (e.message || e));
                    stopVoiceInput();
                }
            }
        }
        
        function stopVoiceInput() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // –£–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                }
            }
            
            if (currentVoiceField) {
                const btn = document.querySelector(`[onclick*="${currentVoiceField}"]`);
                if (btn) {
                    btn.classList.remove('recording');
                    btn.textContent = 'üé§';
                }
            }
            
            currentVoiceField = null;
        }
        
        function applyAllAISuggestions() {
            const fields = {
                'title': 'input[name="title"]',
                'brand': 'input[name="brand"]',
                'description': 'textarea[name="description"]',
                'category': 'input[name="category"]',
                'price': 'input[name="price"]',
                'size': 'input[name="size"]',
                'color': 'input[name="color"]'
            };
            
            let applied = false;
            
            for (const [key, selector] of Object.entries(fields)) {
                const aiField = document.getElementById(`ai-${key}`);
                const formField = document.querySelector(selector);
                
                if (aiField && aiField.value && formField) {
                    if (key === 'price') {
                        formField.value = parseFloat(aiField.value) || '';
                    } else {
                        formField.value = aiField.value;
                    }
                    applied = true;
                }
            }
            
            if (applied) {
                alert('‚úÖ –í—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.');
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
                document.querySelector('.product-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è');
            }
        }
        
        function applyAISuggestions() {
            applyAllAISuggestions();
        }
        
        async function generateSummary() {
            const btn = document.getElementById('generate-summary-btn');
            const loadingDiv = document.getElementById('summary-loading');
            const summarySection = document.querySelector('.ai-summary-section');
            
            if (!btn || !loadingDiv) return;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
            loadingDiv.style.display = 'block';
            
            try {
                const contentDiv = document.querySelector('.content');
                const cardId = contentDiv ? contentDiv.getAttribute('data-card-id') : null;
                
                if (!cardId) {
                    throw new Error('ID –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                const response = await fetch(`/photos/api/generate-summary/${cardId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', response.status, errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: errorText };
                    }
                    throw new Error(errorData.error || `HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.summary) {
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–≤–æ–¥–∫–∏ —Å textarea
                    const container = document.createElement('div');
                    container.style.cssText = 'background: white; padding: 20px; border-radius: 6px; margin-bottom: 15px;';
                    
                    const label = document.createElement('label');
                    label.style.cssText = 'display: block; font-weight: bold; margin-bottom: 10px; color: #333;';
                    label.textContent = 'üìù –°–≤–æ–¥–∫–∞ (–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):';
                    container.appendChild(label);
                    
                    const summaryTextarea = document.createElement('textarea');
                    summaryTextarea.id = 'ai-summary-content';
                    summaryTextarea.value = data.summary;
                    summaryTextarea.style.cssText = 'width: 100%; min-height: 300px; padding: 15px; border: 2px solid #ddd; border-radius: 6px; line-height: 1.8; color: #333; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px; resize: vertical;';
                    summaryTextarea.placeholder = '–°–≤–æ–¥–∫–∞ –æ—Ç OpenAI...';
                    container.appendChild(summaryTextarea);
                    
                    const voiceContainer = document.createElement('div');
                    voiceContainer.style.cssText = 'margin-top: 10px; display: flex; gap: 10px; align-items: center;';
                    
                    const voiceBtn = document.createElement('button');
                    voiceBtn.type = 'button';
                    voiceBtn.className = 'voice-btn';
                    voiceBtn.onclick = (e) => startVoiceInput('ai-summary-content', e);
                    voiceBtn.style.cssText = 'background: #9b59b6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;';
                    voiceBtn.textContent = 'üé§ –î–∏–∫—Ç–æ–≤–∞—Ç—å';
                    voiceContainer.appendChild(voiceBtn);
                    
                    const voiceHint = document.createElement('span');
                    voiceHint.style.cssText = 'color: #666; font-size: 12px;';
                    voiceHint.textContent = '–ù–∞–∂–º–∏ üé§ —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É –≥–æ–ª–æ—Å–æ–º';
                    voiceContainer.appendChild(voiceHint);
                    
                    container.appendChild(voiceContainer);
                    
                    // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                    const oldContent = summarySection.querySelector('div[style*="background: white"]');
                    if (oldContent && oldContent.parentNode) {
                        oldContent.parentNode.replaceChild(container, oldContent);
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π
                        const oldBtn = summarySection.querySelector('button');
                        if (oldBtn) {
                            summarySection.insertBefore(container, oldBtn);
                        } else {
                            summarySection.appendChild(container);
                        }
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
                    const applyBtn = document.createElement('button');
                    applyBtn.type = 'button';
                    applyBtn.onclick = applyAISummaryToCard;
                    applyBtn.textContent = '‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–¥–∫—É –∫ –∫–∞—Ä—Ç–æ—á–∫–µ';
                    applyBtn.style.cssText = 'margin-top: 15px; padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px;';
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    const oldBtn = summarySection.querySelector('button[id="generate-summary-btn"]');
                    if (oldBtn) oldBtn.remove();
                    const oldLoading = summarySection.querySelector('#summary-loading');
                    if (oldLoading) oldLoading.remove();
                    const existingApplyBtn = summarySection.querySelector('button[onclick="applyAISummaryToCard()"]');
                    if (existingApplyBtn) existingApplyBtn.remove();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
                    summarySection.appendChild(applyBtn);
                    
                    // –£–±–∏—Ä–∞–µ–º alert - —Å–≤–æ–¥–∫–∞ —É–∂–µ –≤–∏–¥–Ω–∞, –Ω–µ –Ω—É–∂–Ω–æ –∫–ª–∏–∫–∞—Ç—å
                    // alert('‚úÖ –°–≤–æ–¥–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
                } else {
                    const errorMsg = data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É';
                    console.error('Summary generation failed:', data);
                    if (data.traceback) {
                        console.error('Traceback:', data.traceback);
                    }
                    alert('–û—à–∏–±–∫–∞: ' + errorMsg + '\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–∫–∏: ' + error.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–∫—É';
            }
        }
        
        function applyAISummaryToCard() {
            // –ü–∞—Ä—Å–∏–º —Å–≤–æ–¥–∫—É –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
            const summaryDiv = document.querySelector('.ai-summary-section');
            if (!summaryDiv) {
                alert('–°–≤–æ–¥–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            const summaryContent = summaryDiv.querySelector('#ai-summary-content');
            // –ï—Å–ª–∏ —ç—Ç–æ textarea, –±–µ—Ä–µ–º value, –∏–Ω–∞—á–µ textContent/innerText
            const summaryText = summaryContent ? (summaryContent.tagName === 'TEXTAREA' ? summaryContent.value : (summaryContent.textContent || summaryContent.innerText)) : '';
            
            if (!summaryText || summaryText.trim() === '') {
                alert('–°–≤–æ–¥–∫–∞ –ø—É—Å—Ç–∞');
                return;
            }
            
            console.log('Applying summary, text length:', summaryText.length);
            console.log('Summary preview:', summaryText.substring(0, 300));
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Å–≤–æ–¥–∫–∏
            let title = '';
            let description = '';
            let brand = '';
            let category = '';
            let size = '';
            let price = '';
            let color = '';
            let condition = '';
            
            // –ò—â–µ–º –±—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å
            const brandMatch = summaryText.match(/\*\*–ë—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å:\*\*\s*(.+?)(?:\n|$)/i);
            if (brandMatch) {
                const brandModel = brandMatch[1].trim();
                title = brandModel;
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–¥–µ–ª–∏—Ç—å –±—Ä–µ–Ω–¥ –∏ –º–æ–¥–µ–ª—å
                const parts = brandModel.split(/\s+/);
                if (parts.length > 0) {
                    brand = parts[0];
                }
            }
            
            // –ò—â–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ "–†–∞–∑–º–µ—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"
            const sizeMatch = summaryText.match(/\*\*–†–∞–∑–º–µ—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:\*\*\s*(.+?)(?:\n|$)/i);
            if (sizeMatch) {
                const sizeText = sizeMatch[1].trim();
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–º–µ—Ä (–æ–±—ã—á–Ω–æ –≤ –Ω–∞—á–∞–ª–µ, –¥–æ –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–∏ —Å –∑–∞–ø—è—Ç–æ–π)
                const sizeParts = sizeText.split(/[,;]/);
                if (sizeParts.length > 0) {
                    // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–∑–º–µ—Ä–∞: M, L, XL, 42, 10, –∏ —Ç.–¥.
                    const sizePattern = /\b([XS]{1,2}|S|M|L|XL{1,2}|XXL|\d{1,2}(?:\.\d)?)\b/i;
                    const foundSize = sizeText.match(sizePattern);
                    if (foundSize) {
                        size = foundSize[1].trim();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ/—á–∏—Å–ª–æ
                        size = sizeParts[0].trim().split(/\s+/)[0];
                    }
                }
            }
            
            // –ò—â–µ–º —Ü–≤–µ—Ç –∏–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏
            console.log('üîç Searching for color...');
            const colorMatch = summaryText.match(/\*\*–¶–≤–µ—Ç:\*\*\s*([^\n]+?)(?:\n\*\*|$)/i);
            if (colorMatch) {
                const colorText = colorMatch[1].trim();
                console.log('Color section found:', colorText);
                if (colorText && !colorText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω') && !colorText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')) {
                    color = colorText;
                    console.log('‚úÖ Found color from section:', color);
                } else {
                    console.log('‚ö†Ô∏è Color section says "not specified"');
                }
            } else {
                console.log('‚ö†Ô∏è Color section not found, trying alternatives...');
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ "–†–∞–∑–º–µ—Ä –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"
                if (sizeMatch) {
                    const sizeText = sizeMatch[1].trim();
                    console.log('Checking size text for color:', sizeText.substring(0, 100));
                    // –ò—â–µ–º —Ü–≤–µ—Ç –ø–æ—Å–ª–µ —Å–ª–æ–≤–∞ "—Ü–≤–µ—Ç:" –∏–ª–∏ "color:"
                    const colorPatterns = [
                        /—Ü–≤–µ—Ç[:\s]+([^,;.\n]+)/i,
                        /color[:\s]+([^,;.\n]+)/i,
                        /—Ü–≤–µ—Ç[:\s]+([–∞-—è—ë]+)/i,
                        /\b(–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π|—á–µ—Ä–Ω—ã–π|—Å–∏–Ω–∏–π|–±–µ–ª—ã–π|–∫—Ä–∞—Å–Ω—ã–π|–∑–µ–ª–µ–Ω—ã–π|–∂–µ–ª—Ç—ã–π|—Å–µ—Ä—ã–π|–±–µ–∂–µ–≤—ã–π|—Ä–æ–∑–æ–≤—ã–π|—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π|–æ—Ä–∞–Ω–∂–µ–≤—ã–π|–≥–æ–ª—É–±–æ–π|–±–∏—Ä—é–∑–æ–≤—ã–π)\b/i
                    ];
                    
                    for (const pattern of colorPatterns) {
                        const colorInText = sizeText.match(pattern);
                        if (colorInText) {
                            color = colorInText[1].trim();
                            console.log('‚úÖ Found color in characteristics:', color);
                            break;
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –≤ —Ç–µ–∫—Å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏—è
                if (!color) {
                    console.log('Searching for color keywords in full summary...');
                    const colorKeywords = ['–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π', '—á–µ—Ä–Ω—ã–π', '—Å–∏–Ω–∏–π', '–±–µ–ª—ã–π', '–∫—Ä–∞—Å–Ω—ã–π', '–∑–µ–ª–µ–Ω—ã–π', '–∂–µ–ª—Ç—ã–π', 
                                        '—Å–µ—Ä—ã–π', '–±–µ–∂–µ–≤—ã–π', '—Ä–æ–∑–æ–≤—ã–π', '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–æ—Ä–∞–Ω–∂–µ–≤—ã–π', '–≥–æ–ª—É–±–æ–π', '–±–∏—Ä—é–∑–æ–≤—ã–π',
                                        'brown', 'black', 'blue', 'white', 'red', 'green', 'yellow', 'gray', 'grey', 'beige'];
                    for (const keyword of colorKeywords) {
                        const regex = new RegExp(`\\b${keyword}\\b`, 'i');
                        if (summaryText.match(regex)) {
                            color = keyword;
                            console.log('‚úÖ Found color by keyword:', color);
                            break;
                        }
                    }
                }
            }
            
            if (!color) {
                console.warn('‚ùå Color not found in summary');
            }
            
            // –ò—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            const conditionMatch = summaryText.match(/\*\*–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:\*\*\s*(.+?)(?:\n|$)/i);
            if (conditionMatch) {
                const conditionText = conditionMatch[1].trim().toLowerCase();
                if (conditionText.includes('new') || conditionText.includes('–Ω–æ–≤–æ–µ') || conditionText.includes('–Ω–æ–≤—ã–π')) {
                    condition = 'new';
                    console.log('‚úÖ Found condition: new');
                } else if (conditionText.includes('used') || conditionText.includes('–±/—É') || conditionText.includes('–±—ã–≤—à–∏–π –≤ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏')) {
                    condition = 'used';
                    console.log('‚úÖ Found condition: used');
                } else if (conditionText.includes('refurbished') || conditionText.includes('–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ')) {
                    condition = 'refurbished';
                    console.log('‚úÖ Found condition: refurbished');
                }
            }
            
            // –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ)
            // –ò—â–µ–º —Å–µ–∫—Ü–∏—é "–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏" - –æ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤ —Å–≤–æ–¥–∫–µ, –±–µ—Ä–µ–º –≤—Å—ë –¥–æ –∫–æ–Ω—Ü–∞
            const descMatch = summaryText.match(/\*\*–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:\*\*\s*([\s\S]+)$/i);
            if (descMatch && descMatch[1]) {
                description = descMatch[1].trim();
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ
                description = description.replace(/^\s+|\s+$/g, '');
                // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
                description = description.replace(/^\n+|\n+$/g, '');
                console.log('‚úÖ Found description for sale, length:', description.length);
                console.log('Description preview:', description.substring(0, 100));
            } else {
                console.warn('‚ö†Ô∏è Description for sale not found in summary');
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
                description = '';
            }
            
            // –ò—â–µ–º —Ü–µ–Ω—É –∏ –≤—ã—á–∏—Å–ª—è–µ–º -20%
            console.log('üîç Searching for price...');
            // –ò—â–µ–º —Å–µ–∫—Ü–∏—é —Å —Ü–µ–Ω–æ–π - —Ü–µ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ, –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π, –∏–ª–∏ —á–µ—Ä–µ–∑ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω –∫–æ—Ç–æ—Ä—ã–π –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π —Å–µ–∫—Ü–∏–∏
            const priceSectionMatch = summaryText.match(/\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ \(USD\):\*\*\s*([\s\S]*?)(?:\n\*\*|$)/i);
            
            if (priceSectionMatch) {
                let priceText = priceSectionMatch[1].trim();
                console.log('Price section content:', priceText);
                
                // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã/–ø–µ—Ä–µ–Ω–æ—Å—ã, –∏—â–µ–º —á–∏—Å–ª–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ
                if (!priceText || priceText === '' || /^\s*$/.test(priceText) || priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–∞') || priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')) {
                    // –ò—â–µ–º —á–∏—Å–ª–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ —Ü–µ–Ω–æ–π)
                    const priceOnNextLine = summaryText.match(/\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ \(USD\):\*\*\s*\n\s*(\d+\.?\d*)/m);
                    if (priceOnNextLine) {
                        priceText = priceOnNextLine[1].trim();
                        console.log('‚úÖ Price found on next line:', priceText);
                    } else {
                        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ —á–µ—Ä–µ–∑ –æ–¥–Ω—É –∏–ª–∏ –¥–≤–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                        const priceAfterBlank = summaryText.match(/\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ \(USD\):\*\*\s*\n\s*\n\s*(\d+\.?\d*)/m);
                        if (priceAfterBlank) {
                            priceText = priceAfterBlank[1].trim();
                            console.log('‚úÖ Price found after blank line:', priceText);
                        }
                    }
                }
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞
                if (priceText && !priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–∞') && !priceText.toLowerCase().includes('–Ω–µ —É–∫–∞–∑–∞–Ω–æ')) {
                    // –ò—â–µ–º —á–∏—Å–ª–æ –≤ —Ç–µ–∫—Å—Ç–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å –ø—Ä–æ–±–µ–ª–∞–º–∏, –∑–∞–ø—è—Ç—ã–º–∏ –∏ —Ç.–¥.)
                    const numberMatch = priceText.match(/(\d+\.?\d*)/);
                    if (numberMatch) {
                        const cleanPriceText = numberMatch[1].replace(',', '.');
                        const priceNumber = parseFloat(cleanPriceText);
                        console.log('Parsed price number:', priceNumber);
                        if (!isNaN(priceNumber) && priceNumber > 0) {
                            // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—É —Å —É—á–µ—Ç–æ–º -20%
                            const discountedPrice = priceNumber * 0.8;
                            price = discountedPrice.toFixed(2);
                            console.log(`‚úÖ Found price: ${priceNumber}, discounted (-20%): ${price}`);
                        } else {
                            console.warn('Price number is invalid:', cleanPriceText);
                        }
                    }
                } else {
                    console.log('‚ö†Ô∏è Price section says "not specified" or empty');
                }
            } else {
                console.warn('‚ö†Ô∏è Price section header not found');
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Å–µ–∫—Ü–∏–∏ –∏–ª–∏ —Ç–∞–º "–ù–µ —É–∫–∞–∑–∞–Ω–∞", –∏—â–µ–º —Ü–µ–Ω—É –≤–æ –≤—Å–µ–π —Å–≤–æ–¥–∫–µ
            if (!price) {
                console.log('Searching for price in full summary text...');
                // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ü–µ–Ω—É –≤ —Ç–µ–∫—Å—Ç–µ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º - –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
                const pricePatterns = [
                    /\*\*–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞[^\n]*(\d+\.?\d*)/i,  // –¶–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å–µ–∫—Ü–∏–∏
                    /\b(\d{2,3}(?:\.\d{2})?)\s*(USD|–¥–æ–ª–ª–∞—Ä|dollar)/i,  // –ß–∏—Å–ª–æ + USD/–¥–æ–ª–ª–∞—Ä
                    /USD[:\s]+(\d+\.?\d*)/i,
                    /(\d+\.?\d*)\s*USD/i,
                    /—Ü–µ–Ω–∞[:\s]+(\d+\.?\d*)/i,
                    /price[:\s]+(\d+\.?\d*)/i,
                    /\$\s*(\d+\.?\d*)/i,
                    /(\d+\.?\d*)\s*–¥–æ–ª–ª–∞—Ä/i,
                    /\b(\d{2,3}(?:\.\d{2})?)\b/  // –õ—é–±–æ–µ —á–∏—Å–ª–æ –æ—Ç 10 –¥–æ 999 —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–µ—Å—è—Ç–∏—á–Ω—ã–º–∏
                ];
                for (const pattern of pricePatterns) {
                    const matches = summaryText.matchAll(new RegExp(pattern.source, pattern.flags + 'g'));
                    for (const match of matches) {
                        const priceNumber = parseFloat(match[1]);
                        console.log('Found potential price:', match[1], 'parsed:', priceNumber, 'context:', match[0]);
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ä–∞–∑—É–º–Ω–∞—è —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ (–Ω–µ —Ä–∞–∑–º–µ—Ä, –Ω–µ –≥–æ–¥ –∏ —Ç.–¥.)
                        if (!isNaN(priceNumber) && priceNumber >= 10 && priceNumber < 10000) {
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ —Ä–∞–∑–º–µ—Ä (M, L, XL = 10, 11, 12 –≤ ASCII –∏–ª–∏ –ø–æ—Ö–æ–∂–∏–µ)
                            if (priceNumber < 13) {
                                console.log('Skipping - likely size code');
                                continue;
                            }
                            const discountedPrice = priceNumber * 0.8;
                            price = discountedPrice.toFixed(2);
                            console.log(`‚úÖ Found price by pattern: ${priceNumber}, discounted (-20%): ${price}`);
                            break;
                        }
                    }
                    if (price) break;
                }
                
                if (!price) {
                    console.warn('‚ùå Price not found in summary');
                }
            }
            
            // –ò—â–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ "–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä"
            const categoryMatch = summaryText.match(/\*\*–ß—Ç–æ —ç—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä:\*\*\s*(.+?)(?:\n|$)/i);
            if (categoryMatch) {
                const categoryText = categoryMatch[1].toLowerCase();
                console.log('Category text:', categoryText);
                if (categoryText.includes('—Ç–µ—Ä–º–æ–±–µ–ª—å') || categoryText.includes('thermal') || categoryText.includes('base layer') || 
                    categoryText.includes('—Ñ–ª–∏—Å') || categoryText.includes('fleece') || categoryText.includes('–æ–¥–µ–∂–¥–∞') || 
                    categoryText.includes('—Ä—É–±–∞—à–∫–∞') || categoryText.includes('shirt') || categoryText.includes('–∫—É—Ä—Ç–∫–∞') ||
                    categoryText.includes('jacket') || categoryText.includes('—à—Ç–∞–Ω—ã') || categoryText.includes('pants') ||
                    categoryText.includes('—Ç—Ä—É—Å—ã') || categoryText.includes('underwear') || categoryText.includes('–±–µ–ª—å–µ') ||
                    categoryText.includes('—Ñ—É—Ç–±–æ–ª–∫–∞') || categoryText.includes('t-shirt') || categoryText.includes('–∫–æ—Ñ—Ç–∞') ||
                    categoryText.includes('sweater') || categoryText.includes('—Ö—É–¥–∏') || categoryText.includes('hoodie')) {
                    category = '–û–¥–µ–∂–¥–∞';
                    console.log('Category set to: –û–¥–µ–∂–¥–∞');
                } else if (categoryText.includes('–æ–±—É–≤—å') || categoryText.includes('shoe') || categoryText.includes('–±–æ—Ç–∏–Ω–∫–∏') ||
                          categoryText.includes('boots') || categoryText.includes('–∫—Ä–æ—Å—Å–æ–≤–∫–∏') || categoryText.includes('sneakers')) {
                    category = '–û–±—É–≤—å';
                    console.log('Category set to: –û–±—É–≤—å');
                } else if (categoryText.includes('—Å—É–º–∫–∞') || categoryText.includes('bag') || categoryText.includes('—Ä—é–∫–∑–∞–∫') ||
                          categoryText.includes('backpack')) {
                    category = '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã';
                    console.log('Category set to: –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã');
                }
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
            let applied = [];
            
            console.log('Extracted values:', { title, description: description.substring(0, 50), brand, size, price, category, color, condition });
            
            if (title) {
                const titleField = document.querySelector('input[name="title"]');
                if (titleField) {
                    titleField.value = title;
                    applied.push('–Ω–∞–∑–≤–∞–Ω–∏–µ');
                    console.log('‚úÖ Title applied:', title);
                } else {
                    console.warn('‚ùå Title field not found');
                }
            }
            
            if (description) {
                const descField = document.querySelector('textarea[name="description"]');
                if (descField) {
                    descField.value = description;
                    applied.push('–æ–ø–∏—Å–∞–Ω–∏–µ');
                    console.log('‚úÖ Description applied, length:', description.length);
                } else {
                    console.warn('‚ùå Description field not found');
                }
            }
            
            if (brand) {
                const brandField = document.querySelector('input[name="brand"]');
                if (brandField) {
                    brandField.value = brand;
                    applied.push('–±—Ä–µ–Ω–¥');
                    console.log('‚úÖ Brand applied:', brand);
                } else {
                    console.warn('‚ùå Brand field not found');
                }
            }
            
            if (size) {
                const sizeField = document.querySelector('input[name="size"]');
                if (sizeField) {
                    sizeField.value = size;
                    applied.push('—Ä–∞–∑–º–µ—Ä');
                    console.log('‚úÖ Size applied:', size);
                } else {
                    console.warn('‚ùå Size field not found');
                }
            }
            
            if (price) {
                const priceField = document.querySelector('input[name="price"]');
                if (priceField) {
                    priceField.value = price;
                    applied.push(`—Ü–µ–Ω–∞ (${price} USD)`);
                    console.log('‚úÖ Price applied:', price);
                } else {
                    console.warn('‚ùå Price field not found');
                }
            }
            
            if (category) {
                const catField = document.querySelector('input[name="category"]');
                if (catField) {
                    catField.value = category;
                    applied.push('–∫–∞—Ç–µ–≥–æ—Ä–∏—è');
                    console.log('‚úÖ Category applied:', category);
                } else {
                    console.warn('‚ùå Category field not found');
                }
            }
            
            if (color) {
                const colorField = document.querySelector('input[name="color"]');
                if (colorField) {
                    colorField.value = color;
                    applied.push('—Ü–≤–µ—Ç');
                    console.log('‚úÖ Color applied:', color);
                } else {
                    console.warn('‚ùå Color field not found');
                }
            }
            
            if (condition) {
                const conditionField = document.querySelector('select[name="condition"]');
                if (conditionField) {
                    conditionField.value = condition;
                    applied.push('—Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                    console.log('‚úÖ Condition applied:', condition);
                } else {
                    console.warn('‚ùå Condition field not found');
                }
            }
            
            if (applied.length > 0) {
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ –±–µ–∑ alert
                document.querySelector('.product-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log(`‚úÖ –°–≤–æ–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞! –ó–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è: ${applied.join(', ')}`);
            } else {
                console.error('No fields were applied. Summary text:', summaryText.substring(0, 200));
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Å–≤–æ–¥–∫–∏. –ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é –∏ –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
            }
        }
        
        async function generateFromInstruction() {
            const instructionField = document.getElementById('voice-instruction');
            const instruction = instructionField ? instructionField.value.trim() : '';
            
            if (!instruction) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏–ª–∏ –ø—Ä–æ–¥–∏–∫—Ç—É–π—Ç–µ –µ—ë —á–µ—Ä–µ–∑ üé§');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º card_id –∏–∑ data –∞—Ç—Ä–∏–±—É—Ç–∞
            const contentDiv = document.querySelector('.content');
            const cardId = contentDiv ? contentDiv.getAttribute('data-card-id') : null;
            
            if (!cardId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∫–∞—Ä—Ç–æ—á–∫–∏');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é...';
            
            try {
                const url = `/photos/api/generate-from-instruction/${cardId}/`;
                console.log('Sending request to:', url);
                console.log('Instruction:', instruction);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ instruction: instruction })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('API response:', data);
                
                if (data.success && data.result) {
                    const result = data.result;
                    console.log('Generated result:', result);
                    console.log('Result keys:', Object.keys(result));
                    console.log('Result values:', Object.values(result));
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
                    if (result.error) {
                        alert('–û—à–∏–±–∫–∞ OpenAI API: ' + result.error + '\n\n–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
                        return;
                    }
                    
                    let updatedFields = [];
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –Ω–∞–ø—Ä—è–º—É—é (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                    const fieldMappings = {
                        'title': 'input[name="title"]',
                        'description': 'textarea[name="description"]',
                        'brand': 'input[name="brand"]',
                        'category': 'input[name="category"]',
                        'price': 'input[name="price"]',
                        'size': 'input[name="size"]',
                        'color': 'input[name="color"]'
                    };
                    
                    for (const [key, selector] of Object.entries(fieldMappings)) {
                        const value = result[key];
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å –∏ –Ω–µ null/None
                        if (value !== undefined && value !== null && value !== '' && value !== 'None' && String(value).toLowerCase() !== 'null') {
                            const field = document.querySelector(selector);
                            if (field) {
                                if (key === 'price') {
                                    const numValue = parseFloat(value);
                                    if (!isNaN(numValue) && numValue > 0) {
                                        field.value = numValue;
                                    } else {
                                        continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é —Ü–µ–Ω—É
                                    }
                                } else {
                                    field.value = String(value);
                                }
                                updatedFields.push(key);
                                console.log(`Updated ${key}:`, value);
                                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                                field.dispatchEvent(new Event('input', { bubbles: true }));
                            } else {
                                console.warn(`Field not found for ${key} with selector ${selector}`);
                            }
                        } else {
                            console.log(`Skipping ${key} - value is empty/null:`, value);
                        }
                    }
                    
                    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è AI –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (result.title) {
                        const aiTitle = document.getElementById('ai-title');
                        if (aiTitle) aiTitle.value = result.title;
                    }
                    if (result.brand) {
                        const aiBrand = document.getElementById('ai-brand');
                        if (aiBrand) aiBrand.value = result.brand;
                    }
                    if (result.description) {
                        const aiDesc = document.getElementById('ai-description');
                        if (aiDesc) {
                            aiDesc.value = result.description;
                            console.log('Updated AI description field');
                        }
                    }
                    if (result.category) {
                        const aiCat = document.getElementById('ai-category');
                        if (aiCat) aiCat.value = result.category;
                    }
                    if (result.price) {
                        const aiPrice = document.getElementById('ai-price');
                        if (aiPrice) aiPrice.value = result.price;
                    }
                    if (result.size) {
                        const aiSize = document.getElementById('ai-size');
                        if (aiSize) aiSize.value = result.size;
                    }
                    if (result.color) {
                        const aiColor = document.getElementById('ai-color');
                        if (aiColor) aiColor.value = result.color;
                    }
                    if (result.material) {
                        const aiMaterial = document.getElementById('ai-material');
                        if (aiMaterial) aiMaterial.value = result.material;
                    }
                    
                    if (updatedFields.length > 0) {
                        alert(`‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ! –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–ª—è: ${updatedFields.join(', ')}. –ü—Ä–æ–≤–µ—Ä—å –∏ –Ω–∞–∂–º–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è".`);
                        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
                        const descField = document.querySelector('textarea[name="description"]');
                        if (descField) {
                            descField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            descField.focus();
                        }
                    } else {
                        console.warn('No fields were updated. Result:', result);
                        console.warn('Available result keys:', Object.keys(result || {}));
                        alert('‚ö†Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç: ' + JSON.stringify(result, null, 2));
                    }
                } else {
                    console.error('API error:', data);
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
</body>
</html>

