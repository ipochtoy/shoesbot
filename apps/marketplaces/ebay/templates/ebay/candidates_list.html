{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}eBay Candidates{% endblock %}

{% block content %}
<div class="ebay-candidates-page">
    <h1>eBay Listing Candidates</h1>

    <div class="filters">
        <form method="get" class="filters-form">
            <select name="status">
                <option value="">All Statuses</option>
                <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Draft</option>
                <option value="ready" {% if request.GET.status == 'ready' %}selected{% endif %}>Ready</option>
                <option value="listed" {% if request.GET.status == 'listed' %}selected{% endif %}>Listed</option>
                <option value="error" {% if request.GET.status == 'error' %}selected{% endif %}>Error</option>
                <option value="ended" {% if request.GET.status == 'ended' %}selected{% endif %}>Ended</option>
            </select>

            <input type="text" name="q" placeholder="Search..." value="{{ request.GET.q }}">

            <label>
                <input type="checkbox" name="heavy" value="1" {% if request.GET.heavy %}checked{% endif %}>
                Heavy only
            </label>

            <button type="submit">Filter</button>
            <a href="{% url 'admin:ebay_ebaycandidate_changelist' %}">View in Admin</a>
        </form>
    </div>

    <div class="candidates-list">
        {% for candidate in candidates %}
        <div class="candidate-card status-{{ candidate.status }}">
            <div class="candidate-header">
                <h3>{{ candidate.title|default:"Untitled" }}</h3>
                <span class="status-badge">{{ candidate.get_status_display }}</span>
            </div>

            <div class="candidate-body">
                <div class="candidate-photos">
                    {% if candidate.photos %}
                        <img src="{{ candidate.photos.0 }}" alt="Product photo">
                    {% else %}
                        <div class="no-photo">No photo</div>
                    {% endif %}
                </div>

                <div class="candidate-info">
                    <p><strong>Batch:</strong> {{ candidate.photo_batch.title|default:candidate.photo_batch.correlation_id }}</p>
                    <p><strong>Category:</strong> {{ candidate.category_id|default:"Not set" }}</p>
                    <p><strong>Condition:</strong> {{ candidate.get_condition_display|default:"Not set" }}</p>
                    <p><strong>Price:</strong> ${{ candidate.price_final|default:"â€“" }}</p>

                    {% if candidate.ebay_item_id %}
                    <p><strong>eBay ID:</strong> {{ candidate.ebay_item_id }}</p>
                    {% endif %}

                    {% if candidate.missing_required_fields %}
                    <p class="warning"><strong>Missing:</strong> {{ candidate.missing_required_fields|join:", " }}</p>
                    {% endif %}
                </div>
            </div>

            <div class="candidate-actions">
                <a href="{% url 'admin:ebay_ebaycandidate_change' candidate.id %}">Edit</a>

                {% if candidate.status == 'draft' %}
                <button onclick="prepareCandidate({{ candidate.id }})">Prepare</button>
                {% endif %}

                {% if candidate.status == 'ready' %}
                <button onclick="publishCandidate({{ candidate.id }})">Publish</button>
                {% endif %}

                {% if candidate.status == 'listed' %}
                <button onclick="endCandidate({{ candidate.id }})">End</button>
                <button onclick="repriceCandidate({{ candidate.id }})">Reprice</button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p>No candidates found.</p>
        {% endfor %}
    </div>

    <div class="pagination">
        {% if candidates.has_previous %}
        <a href="?page={{ candidates.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
        {% endif %}

        <span>Page {{ candidates.number }} of {{ candidates.paginator.num_pages }}</span>

        {% if candidates.has_next %}
        <a href="?page={{ candidates.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
        {% endif %}
    </div>
</div>

<style>
.ebay-candidates-page {
    padding: 20px;
}

.filters-form {
    margin: 20px 0;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 5px;
}

.filters-form select,
.filters-form input[type="text"] {
    margin-right: 10px;
    padding: 5px 10px;
}

.candidates-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.candidate-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background: white;
}

.candidate-card.status-listed {
    border-left: 4px solid #28a745;
}

.candidate-card.status-ready {
    border-left: 4px solid #17a2b8;
}

.candidate-card.status-draft {
    border-left: 4px solid #6c757d;
}

.candidate-card.status-error {
    border-left: 4px solid #dc3545;
}

.candidate-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    background: #6c757d;
    color: white;
}

.candidate-photos img {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 4px;
}

.no-photo {
    width: 100%;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    border-radius: 4px;
    color: #999;
}

.candidate-info {
    margin: 15px 0;
}

.candidate-info p {
    margin: 5px 0;
}

.warning {
    color: #dc3545;
}

.candidate-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.candidate-actions button,
.candidate-actions a {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-decoration: none;
    cursor: pointer;
    background: white;
}

.candidate-actions button:hover,
.candidate-actions a:hover {
    background: #f5f5f5;
}

.pagination {
    margin: 20px 0;
    text-align: center;
}

.pagination a {
    margin: 0 10px;
}
</style>

<script>
function prepareCandidate(id) {
    if (confirm('Prepare this candidate?')) {
        fetch(`/api/ebay/candidates/${id}/prepare/`, {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
    }
}

function publishCandidate(id) {
    if (confirm('Publish to eBay?')) {
        fetch(`/api/ebay/candidates/${id}/publish/`, {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
    }
}

function endCandidate(id) {
    if (confirm('End this listing?')) {
        fetch(`/api/ebay/candidates/${id}/end/`, {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
    }
}

function repriceCandidate(id) {
    if (confirm('Reprice based on current market?')) {
        fetch(`/api/ebay/candidates/${id}/reprice/`, {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
    }
}
</script>
{% endblock %}
