<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analysis - eBay Candidate #{{ candidate.id }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .header h1 {
            font-size: 24px;
            color: #111827;
        }
        .back-link {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .photos-section {
            margin-bottom: 30px;
        }
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .photo-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            cursor: move;
            transition: all 0.2s;
            background: white;
        }
        .photo-item:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .photo-item.main-photo {
            border-color: #28a745;
        }
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            cursor: pointer;
        }
        .photo-controls {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            max-width: 90px;
            z-index: 10;
        }
        .photo-controls .btn {
            padding: 2px 4px;
            font-size: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }
        .photo-controls .btn-star {
            background: rgba(245, 158, 11, 0.9);
        }
        .photo-controls .btn-delete {
            background: rgba(239, 68, 68, 0.9);
        }
        .photo-main-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: #f59e0b;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
            z-index: 10;
        }
        .photo-info {
            padding: 3px 4px;
            background: #f9fafb;
            font-size: 8px;
            color: #6b7280;
        }
        .photo-info .fashn-buttons {
            display: flex;
            gap: 2px;
            margin-top: 3px;
            flex-wrap: wrap;
        }
        .photo-info .fashn-buttons button {
            flex: 1;
            padding: 2px 3px;
            font-size: 7px;
            min-width: 40px;
            margin-top: 0;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .photo-info .fashn-buttons .btn-mannequin {
            background: #8b5cf6;
        }
        .photo-info .fashn-buttons .btn-enhance {
            background: #ec4899;
        }
        .btn-enhance:disabled,
        .btn-mannequin:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .barcodes-section {
            margin-bottom: 10px;
            padding: 8px 0;
            font-size: 11px;
            color: #6b7280;
            line-height: 1.6;
        }
        .barcodes-section .barcode-item {
            display: inline;
            font-family: monospace;
        }
        .barcodes-section .barcode-item:not(:last-child)::after {
            content: ', ';
        }
        .analysis-section {
            margin-bottom: 30px;
        }
        .btn-analyze {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-openai {
            background: #10b981;
            color: white;
        }
        .btn-openai:hover {
            background: #059669;
        }
        .btn-google {
            background: #3b82f6;
            color: white;
        }
        .btn-google:hover {
            background: #2563eb;
        }
        .btn-both {
            background: #8b5cf6;
            color: white;
        }
        .btn-both:hover {
            background: #7c3aed;
        }
        .btn-ebay {
            background: #f59e0b;
            color: white;
        }
        .btn-ebay:hover {
            background: #d97706;
        }
        .btn-autofill {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: #10b981;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
        }
        .btn-autofill:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(16, 185, 129, 0.3);
        }
        .btn-autofill:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .analysis-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .inline-status {
            align-self: center;
            font-size: 12px;
            color: #6b7280;
        }
        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .result-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }
        .result-card.openai {
            border-color: #10b981;
        }
        .result-card.google {
            border-color: #3b82f6;
        }
        .result-card h3 {
            margin-bottom: 15px;
            color: #111827;
        }
        .result-card.openai h3 {
            color: #10b981;
        }
        .result-card.google h3 {
            color: #3b82f6;
        }
        .result-summary {
            background: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-data {
            margin-top: 15px;
        }
        .result-data-item {
            margin-bottom: 10px;
            padding: 8px;
            background: #f0fdf4;
            border-radius: 4px;
            font-size: 13px;
        }
        .result-data-item strong {
            color: #059669;
        }
        .btn-select {
            margin-top: 15px;
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }
        .btn-select:hover {
            background: #1d4ed8;
        }
        .btn-combine {
            margin-top: 15px;
            padding: 10px 20px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }
        .btn-combine:hover {
            background: #7c3aed;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .error {
            padding: 15px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            color: #dc2626;
            margin-top: 10px;
        }
        .continue-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
        }
        .btn-continue {
            padding: 15px 40px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-continue:hover {
            background: #059669;
        }
        .btn-continue:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .extracted-data-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #bae6fd;
        }
        .extracted-data-section h3 {
            margin-bottom: 15px;
            color: #0369a1;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .data-item {
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e7ff;
        }
        .data-item strong {
            display: block;
            color: #4338ca;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .data-item span {
            color: #1e293b;
            font-size: 14px;
            word-break: break-word;
        }
        .stock-photos-section {
            margin-top: 30px;
            padding: 20px;
            background: #fef3c7;
            border-radius: 6px;
            border: 1px solid #fcd34d;
        }
        .stock-photos-section h3 {
            margin-bottom: 15px;
            color: #92400e;
        }
        .stock-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .stock-photo-item {
            position: relative;
            border: 2px solid #fbbf24;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stock-photo-item:hover {
            transform: scale(1.05);
            border-color: #f59e0b;
        }
        .stock-photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .stock-photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px;
            font-size: 10px;
            text-align: center;
        }
        .ebay-comps-section {
            margin-top: 20px;
            margin-bottom: 30px;
        }
        .ebay-comps-section h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .ebay-comps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .ebay-comp-item {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            cursor: pointer;
            transition: box-shadow 0.2s;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        .ebay-comp-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .ebay-comp-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: #f9fafb;
        }
        .ebay-comp-info {
            padding: 8px;
        }
        .ebay-comp-title {
            font-size: 11px;
            color: #374151;
            margin-bottom: 6px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .ebay-comp-price {
            font-size: 13px;
            font-weight: 600;
            color: #059669;
            margin-bottom: 4px;
        }
        .ebay-comp-condition {
            font-size: 10px;
            color: #6b7280;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ü§ñ AI Analysis</h1>
                <p style="color: #6b7280; margin-top: 5px;">
                    Candidate #{{ candidate.id }} | 
                    {% if candidate.photo_batch %}
                        Source: {{ candidate.photo_batch.correlation_id }}
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{% url 'admin:ebay_ebaycandidate_changelist' %}" class="back-link">‚Üê Back to List</a>
            </div>
        </div>

        <!-- Barcodes & GG Labels Section - Compact -->
        <div class="barcodes-section">
            {% if barcodes %}
            <span style="color: #9ca3af;">Barcodes:</span>
            {% for barcode in barcodes %}
            <span class="barcode-item">{{ barcode }}</span>
            {% endfor %}
            {% else %}
            <span style="color: #9ca3af;">Barcodes: <em style="color: #d1d5db;">none</em></span>
            {% endif %}
            {% if barcodes and gg_labels %}<br>{% elif barcodes %}<br>{% endif %}
            {% if gg_labels %}
            <span style="color: #9ca3af;">GG Labels:</span>
            {% for label in gg_labels %}
            <span class="barcode-item" style="color: #856404; font-weight: 500;">{{ label }}</span>
            {% endfor %}
            {% else %}
            <span style="color: #9ca3af;">GG Labels: <em style="color: #d1d5db;">none</em></span>
            {% endif %}
        </div>

        <!-- Photos Section -->
        <div class="photos-section">
            <h2 style="margin-bottom: 15px;">üì∏ Product Photos</h2>
            <div class="photos-grid">
                {% for photo in photos %}
                <div class="photo-item {% if photo.is_main %}main-photo{% endif %}" id="photo-{{ photo.id }}" data-photo-id="{{ photo.id }}" data-photo-url="{{ photo.url }}">
                    {% if photo.is_main %}
                    <div class="photo-main-badge">‚≠ê –ì–ª–∞–≤–Ω–æ–µ</div>
                    {% endif %}
                    <div class="photo-controls">
                        <button type="button" onclick="setMainPhoto({{ photo.id }})" class="btn btn-star" title="–°–¥–µ–ª–∞—Ç—å –≥–ª–∞–≤–Ω–æ–π">‚≠ê</button>
                        <button type="button" onclick="rotatePhoto({{ photo.id }}, 'left')" class="btn" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ª–µ–≤–æ">‚Ü∂</button>
                        <button type="button" onclick="rotatePhoto({{ photo.id }}, 'right')" class="btn" title="–ü–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ø—Ä–∞–≤–æ">‚Ü∑</button>
                        <button type="button" onclick="deletePhoto({{ photo.id }})" class="btn btn-delete" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                    </div>
                    <img src="{{ photo.url }}" alt="Product photo" onclick="openLightbox('{{ photo.url }}')" style="cursor: pointer;">
                    <div class="photo-info">
                        <div class="fashn-buttons">
                            <button type="button" onclick="enhancePhoto({{ photo.id }}, 'ghost_mannequin')" class="btn-mannequin" title="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ (FASHN AI, ~30 —Å–µ–∫)">
                                üë§
                            </button>
                            <button type="button" onclick="enhancePhoto({{ photo.id }}, 'product_beautifier')" class="btn-enhance" title="–£–ª—É—á—à–∏—Ç—å —Ñ–æ—Ç–æ (FASHN AI, ~30 —Å–µ–∫)">
                                ‚ú®
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="analysis-section">
            <h2 style="margin-bottom: 15px;">üîç Run AI Analysis</h2>
            <div class="analysis-controls">
                <button class="btn-analyze btn-openai" onclick="runAnalysis('openai')">
                    ü§ñ OpenAI Analysis
                </button>
                <button class="btn-analyze btn-google" onclick="runAnalysis('google')">
                    üîç Google Analysis
                </button>
                <button class="btn-analyze btn-both" onclick="runAnalysis('both')">
                    üöÄ Both (Compare)
                </button>
                <input id="ebay-query" type="text" placeholder="–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                       style="padding: 10px 12px; border:1px solid #d1d5db; border-radius:6px; min-width: 260px;">
                <button class="btn-analyze btn-ebay" onclick="searchEbay()" style="background: #f59e0b; color: white;">
                    üõí Search eBay
                </button>
                <span id="ebay-status" class="inline-status"></span>
            </div>

            <!-- eBay Similar Listings -->
            {% if ebay_comps %}
            <div class="ebay-comps-section">
                <h3>üõí Similar eBay Listings</h3>
                <div class="ebay-comps-grid">
                    {% for comp in ebay_comps %}
                    <a href="{{ comp.url }}" target="_blank" class="ebay-comp-item" title="{{ comp.title }}">
                        {% if comp.image_url %}
                        <img src="{{ comp.image_url }}" alt="{{ comp.title|truncatewords:5 }}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'140\' height=\'120\'%3E%3Crect fill=\'%23f3f4f6\' width=\'140\' height=\'120\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'sans-serif\' font-size=\'12\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';">
                        {% else %}
                        <div style="width: 100%; height: 120px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 11px;">No Image</div>
                        {% endif %}
                        <div class="ebay-comp-info">
                            <div class="ebay-comp-title">{{ comp.title|truncatewords:8 }}</div>
                            <div class="ebay-comp-price">${{ comp.price|floatformat:2 }}{% if comp.shipping_cost > 0 %} + ${{ comp.shipping_cost|floatformat:2 }}{% endif %}</div>
                            <div class="ebay-comp-condition">{{ comp.condition_text|default:comp.condition }}</div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        <div id="autofill-preview" class="results-container" style="display:none;"></div>
        <div id="results-container" class="results-container"></div>
        <div id="ebay-results-container" class="results-container" style="margin-top:20px;"></div>
        <div class="results-container" style="margin-top:20px; background:#f0fdf4; border:2px solid #6ee7b7; border-radius:10px; padding:18px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
                <div style="flex:1; min-width:240px;">
                    <h3 style="color:#047857; margin-bottom:6px;">‚ú® Auto-fill Listing</h3>
                    <p style="font-size:13px; color:#047857;">
                        –°–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å GPT, Google –∏ eBay comps –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                    </p>
                </div>
                <button class="btn-autofill" onclick="autoFillCandidate()">
                    ‚ú® Auto-fill Listing
                </button>
            </div>
        </div>
        </div>

        <!-- Continue Section -->
        <div class="continue-section">
            <button id="btn-continue" class="btn-continue" onclick="continueToEdit()" disabled>
                Continue to Edit Page ‚Üí
            </button>
            <p style="margin-top: 10px; color: #6b7280; font-size: 14px;">
                Select or combine analysis results to proceed
            </p>
        </div>
    </div>

    <script>
        const candidateId = {{ candidate.id }};
        let selectedData = null;
        let lastOpenAi = null;
        let autofillData = null;

        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, value] = cookie.trim().split('=');
                if (key === 'csrftoken') return value;
            }
            return '';
        }

        async function runAnalysis(provider) {
            const container = document.getElementById('results-container');
            container.innerHTML = '<div class="loading">üîÑ Analyzing... This may take 30-60 seconds</div>';

            try {
                const base = location.pathname.startsWith('/dev/') ? '/dev' : '';
                const response = await fetch(`${base}/api/ebay/analyze/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({
                        candidate_id: candidateId,
                        provider: provider
                    })
                });

                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }

                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON but got ${contentType}. Response: ${text.substring(0, 200)}`);
                }

                const data = await response.json();
                try {
                    lastOpenAi = (data && data.openai && data.openai.success) ? (data.openai.data || null) : null;
                } catch (e) {
                    lastOpenAi = null;
                }
                // –û–±–Ω–æ–≤–∏–º –≤–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ Barcodes/GG Labels —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                try {
                    if (lastOpenAi) {
                        const top = document.querySelector('.barcodes-section');
                        if (top) {
                            const existingBarcodes = Array.from(top.querySelectorAll('.barcode-item'))
                                .map(el => (el.textContent || '').trim())
                                .filter(Boolean);
                            let mergedBarcodes = [...existingBarcodes];
                            (lastOpenAi.barcodes || []).forEach(b => {
                                if (b && !mergedBarcodes.includes(b)) mergedBarcodes.push(b);
                            });
                            // –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã—Ç–∞—â–∏—Ç—å GG/Q –∏–∑ —Ç–µ–∫—Å—Ç–∞
                            const summary = (data.openai.summary || '').toString();
                            const ggMatches = summary.match(/\b(GG\d{3,}|Q\d{3,})\b/gi) || [];
                            ggMatches.forEach(g => {
                                if (g && !mergedBarcodes.includes(g)) mergedBarcodes.push(g);
                            });
                            // –ü–µ—Ä–µ—Ä–∏—Å—É–µ–º –±–ª–æ–∫
                            top.innerHTML = '';
                            const bSpan = document.createElement('span');
                            bSpan.style.color = '#9ca3af';
                            bSpan.textContent = 'Barcodes:';
                            top.appendChild(bSpan);
                            if (mergedBarcodes.length) {
                                mergedBarcodes.forEach(code => {
                                    const s = document.createElement('span');
                                    s.className = 'barcode-item';
                                    s.textContent = code;
                                    s.style.marginLeft = '4px';
                                    top.appendChild(s);
                                });
                            } else {
                                const none = document.createElement('em');
                                none.style.color = '#d1d5db';
                                none.textContent = 'none';
                                const wrap = document.createElement('span');
                                wrap.style.color = '#9ca3af';
                                wrap.appendChild(document.createTextNode(' '));
                                wrap.appendChild(none);
                                top.appendChild(document.createTextNode(' '));
                                top.appendChild(wrap);
                            }
                        }
                    }
                } catch (e) {}
                displayResults(data, provider);
            } catch (error) {
                console.error('Analysis error:', error);
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function searchEbay() {
            const ebayBox = document.getElementById('ebay-results-container');
            ebayBox.innerHTML = '<div class="loading">üõí –ò—â—É –Ω–∞ eBay... (10‚Äì20 —Å–µ–∫)</div>';
            const btn = document.querySelector('.btn-ebay');
            const statusEl = document.getElementById('ebay-status');
            const oldBtnHtml = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Searching...';
            }
            if (statusEl) {
                statusEl.textContent = '–ó–∞–ø—É—Å—Ç–∏–ª –ø–æ–∏—Å–∫...';
            }

            try {
                const base = location.pathname.startsWith('/dev/') ? '/dev' : '';
                // Build a better query from the last OpenAI analysis if available
                let bestQuery = null;
                if (lastOpenAi) {
                    const brand = (lastOpenAi.brand || '').toString().trim();
                    const model = (lastOpenAi.model || '').toString().trim();
                    const sq = (lastOpenAi.search_query || '').toString().trim();
                    if (brand && model) bestQuery = `${brand} ${model}`;
                    else if (sq) bestQuery = sq;
                    else if (brand) bestQuery = brand;
                }
                const manual = (document.getElementById('ebay-query')?.value || '').trim();
                const used = manual || bestQuery || undefined;
                if (statusEl && used) {
                    statusEl.textContent = `–ó–∞–ø—Ä–æ—Å: ${used} ‚Ä¢ –ò—â—É...`;
                }
                const response = await fetch(`${base}/api/ebay/search/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({
                        candidate_id: candidateId,
                        query: used
                    })
                });

                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }

                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON but got ${contentType}. Response: ${text.substring(0, 200)}`);
                }

                const data = await response.json();
                displayEbayResults(data);
                if (statusEl) {
                    const cnt = (data && Array.isArray(data.comps)) ? data.comps.length : 0;
                    statusEl.textContent = cnt > 0 ? `–ì–æ—Ç–æ–≤–æ: –Ω–∞–π–¥–µ–Ω–æ ${cnt}` : '–ì–æ—Ç–æ–≤–æ: –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                }
            } catch (error) {
                console.error('eBay search error:', error);
                ebayBox.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                if (statusEl) {
                    statusEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞';
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = oldBtnHtml || 'üõí Search eBay';
                }
            }
        }

        function displayEbayResults(data) {
            const container = document.getElementById('ebay-results-container');
            let html = '<div class="result-card" style="border-color: #f59e0b;"><h3>üõí eBay Search Results</h3>';

            // Price info
            if (data.price_info) {
                html += `<div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 6px;">
                    <h4 style="margin-bottom: 10px; color: #92400e;">üí∞ Price Information</h4>
                    <div style="font-size: 16px; font-weight: bold; color: #dc2626;">
                        Median: $${data.price_info.price.toFixed(2)}
                    </div>
                    <div style="font-size: 13px; color: #78350f; margin-top: 5px;">
                        Range: $${data.price_info.price_min.toFixed(2)} - $${data.price_info.price_max.toFixed(2)} 
                        (${data.price_info.price_count} listings)
                    </div>
                </div>`;
            }

            if (data.analysis_keywords && data.analysis_keywords.length) {
                html += `<div style="margin-bottom: 15px; padding: 12px; background: #ecfeff; border-radius: 6px;">
                    <h4 style="margin-bottom: 6px; color: #0f766e;">üîë Key Terms (GPT)</h4>
                    <div style="font-size: 13px; color: #0f172a;">${data.analysis_keywords.join(', ')}</div>
                </div>`;
            }

            if ((data.search_terms && data.search_terms.length) || data.used_query) {
                const termsList = (data.search_terms || []).map(term => `<code style="margin-right: 6px;">${term}</code>`).join(' ');
                html += `<div style="margin-bottom: 15px; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                    <h4 style="margin-bottom: 6px; color: #1f2937;">üß† eBay Search Terms</h4>
                    ${data.used_query ? `<div style="font-size: 13px; color: #111827; margin-bottom: 4px;">Used query: <strong>${data.used_query}</strong></div>` : ''}
                    ${termsList ? `<div style="font-size: 12px; color: #4b5563;">Tried: ${termsList}</div>` : ''}
                </div>`;
            }

            // Comps
            if (data.comps && data.comps.length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">üìä Similar Listings (${data.comps.length})</h4>
                    <div class="ebay-comps-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">`;
                
                data.comps.forEach(comp => {
                    const compJson = JSON.stringify(comp).replace(/"/g, '&quot;');
                    html += `
                        <div style="position: relative; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden;">
                            <a href="${comp.url || '#'}" target="_blank" class="ebay-comp-item" style="display: block; text-decoration: none; color: inherit;">
                                ${comp.image_url ? `<img src="${comp.image_url}" alt="${comp.title || ''}" style="width: 100%; height: 100px; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'140\' height=\'100\'%3E%3Crect fill=\'%23f3f4f6\' width=\'140\' height=\'100\'/%3E%3Ctext fill=\'%239ca3af\' font-family=\'sans-serif\' font-size=\'10\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';">` : '<div style="width: 100%; height: 100px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 10px;">No Image</div>'}
                                <div style="padding: 8px; font-size: 11px;">
                                    <div style="font-weight: bold; color: #dc2626; margin-bottom: 4px;">$${comp.price ? comp.price.toFixed(2) : 'N/A'}</div>
                                    <div style="color: #6b7280; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(comp.title || '')}">${escapeHtml((comp.title || '').substring(0, 50))}</div>
                                    ${comp.condition ? `<div style="color: #9ca3af; font-size: 9px; margin-top: 4px;">${escapeHtml(comp.condition)}</div>` : ''}
                                </div>
                            </a>
                            <button 
                                onclick="copyCompListing(${compJson}); event.stopPropagation();" 
                                style="position: absolute; bottom: 4px; right: 4px; background: #10b981; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 9px; cursor: pointer; z-index: 10;"
                                title="Copy this listing details">
                                üìã Copy
                            </button>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // Stock photos
            if (data.stock_photos && data.stock_photos.length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">üì∏ Stock Photos (${data.stock_photos.length})</h4>
                    <div class="stock-photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">`;
                
                data.stock_photos.forEach((photo, index) => {
                    const photoUrl = photo.url || photo;
                    html += `
                        <div class="stock-photo-item" onclick="openLightbox('${photoUrl}')" style="cursor: pointer; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden;">
                            <img src="${photoUrl}" alt="eBay photo ${index + 1}" style="width: 100%; height: 120px; object-fit: cover;" onerror="this.style.display='none';">
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            if (!data.price_info && (!data.comps || data.comps.length === 0) && (!data.stock_photos || data.stock_photos.length === 0)) {
                html += '<div class="error" style="margin-top: 15px;">No results found on eBay. Try searching with a different query or barcode.</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }


        async function autoFillCandidate() {
            const preview = document.getElementById('autofill-preview');
            preview.style.display = 'block';
            preview.innerHTML = '<div class="loading">‚ú® Generating auto-fill recommendation...</div>';
            try {
                const response = await fetch(`/api/ebay/candidates/${candidateId}/autofill/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                }
                const data = await response.json();
                autofillData = data;

                const patchPayload = {...(data.fields || {})};
                if (patchPayload.price_recommended !== undefined) {
                    patchPayload.price_suggested = patchPayload.price_recommended;
                }
                delete patchPayload.price_recommended;
                delete patchPayload.price_info;

                sessionStorage.setItem(`ebay_autofill_fields_${candidateId}`, JSON.stringify(patchPayload));
                sessionStorage.setItem(`ebay_autofill_meta_${candidateId}`, JSON.stringify({
                    price_info: data.fields?.price_info || {},
                    comps: data.comps || [],
                    stock_photos: data.stock_photos || [],
                }));

                const updatePayload = {};
                ['title','description_md','condition','category_id','specifics','photo_queries','keywords','barcodes','gg_labels','price_suggested'].forEach(key => {
                    if (patchPayload[key] !== undefined) {
                        updatePayload[key] = patchPayload[key];
                    }
                });
                if (patchPayload.price_suggested === undefined && patchPayload.price === undefined && data.fields?.price_recommended) {
                    updatePayload.price_suggested = data.fields.price_recommended;
                }

                selectedData = updatePayload;
                document.getElementById('btn-continue').disabled = false;
                renderAutofillPreview(data);
            } catch (error) {
                console.error('Auto-fill error:', error);
                preview.innerHTML = `<div class="error">Auto-fill failed: ${error.message}</div>`;
            }
        }

        function renderAutofillPreview(data) {
            const preview = document.getElementById('autofill-preview');
            if (!data || !data.fields) {
                preview.innerHTML = '<div class="error">No auto-fill data available.</div>';
                return;
            }
            const fields = data.fields;
            const priceInfo = fields.price_info || {};
            const formatCurrency = (value) => {
                const num = Number(value);
                if (Number.isFinite(num)) {
                    return `$${num.toFixed(2)}`;
                }
                return value ? `$${value}` : '‚Äî';
            };
            const recommendedPriceDisplay = fields.price_recommended !== undefined && fields.price_recommended !== null
                ? formatCurrency(fields.price_recommended)
                : '‚Äî';
            const medianTotalDisplay = priceInfo && priceInfo.total_median !== undefined && priceInfo.total_median !== null
                ? formatCurrency(priceInfo.total_median)
                : null;
            const comps = data.comps || [];
            const photos = data.stock_photos || [];
            let html = `<div class="result-card" style="border-color:#10b981;">`;
            html += `<h3>‚ú® Auto-fill Recommendation</h3>`;
            html += `<div style="display:flex; gap:20px; flex-wrap:wrap; margin:15px 0;">
                        <div style="flex:1; min-width:200px;">
                            <h4 style="color:#065f46; margin-bottom:4px;">Title</h4>
                            <div style="font-weight:500; color:#047857;">${escapeHtml(fields.title || '‚Äì')}</div>
                        </div>
                        <div style="width:160px;">
                            <h4 style="color:#065f46; margin-bottom:4px;">Recommended Price</h4>
                            <div style="font-size:18px; font-weight:700; color:#dc2626;">${recommendedPriceDisplay}</div>
                            ${medianTotalDisplay ? `<div style="font-size:12px; color:#4b5563;">Median total: ${medianTotalDisplay}</div>` : ''}
                        </div>
                    </div>`;
            if (fields.keywords && fields.keywords.length) {
                html += `<div style="margin-bottom:12px; font-size:12px; color:#0369a1;"><strong>Keywords:</strong> ${fields.keywords.map(escapeHtml).join(', ')}</div>`;
            }
            if (comps.length) {
                html += `<div style="margin-top:10px;"><h4 style="color:#1f2937;">Top Comparables</h4><div style="display:grid; gap:8px; margin-top:6px;">`;
                comps.slice(0,3).forEach(comp => {
                    html += `<a href="${comp.url}" target="_blank" style="display:flex; gap:10px; align-items:center; padding:8px; border:1px solid #e5e7eb; border-radius:6px; text-decoration:none; color:#111827;">
                                ${comp.image_url ? `<img src="${comp.image_url}" style="width:60px; height:60px; object-fit:cover; border-radius:4px;">` : ''}
                                <div>
                                    <div style="font-weight:600;">$${(comp.price || 0).toFixed ? comp.price.toFixed(2) : comp.price}</div>
                                    <div style="font-size:12px; color:#4b5563;">${escapeHtml(comp.title || '')}</div>
                                </div>
                            </a>`;
                });
                html += '</div></div>';
            }
            if (photos.length) {
                html += `<div style="margin-top:15px;">
                            <h4 style="color:#1d4ed8;">Suggested Stock Photos</h4>
                            <div class="stock-photos-grid" style="margin-top:8px;">`;
                photos.slice(0,6).forEach((photo, idx) => {
                    const url = photo.url || photo;
                    html += `<div class="stock-photo-item" onclick="openLightbox('${url}')">
                                <img src="${photo.thumbnail || url}" alt="auto photo ${idx+1}">
                                <div class="stock-photo-overlay">${escapeHtml((photo.title || 'Auto').substring(0,30))}</div>
                            </div>`;
                });
                html += '</div></div>';
            }
            html += `<div style="margin-top:12px; font-size:12px; color:#6b7280;">Auto-fill data saved. Click "Continue to Edit Page" to apply.</div>`;
            html += '</div>';
            preview.innerHTML = html;
        }


        function displayResults(data, provider) {
            const container = document.getElementById('results-container');
            let html = '';

            if (data.openai && data.openai.success) {
                html += `
                    <div class="result-card openai">
                        <h3>ü§ñ OpenAI Analysis</h3>
                        <div class="result-summary">${escapeHtml(data.openai.summary || 'No summary')}</div>
                        ${displayStructuredData(data.openai.data, 'openai')}
                        ${displayStockPhotos(data.openai.stock_photos, data.openai.photo_queries)}
                        <button class="btn-select" onclick="selectData('openai', ${JSON.stringify(data.openai.data).replace(/"/g, '&quot;')})">
                            ‚úì Use This Data
                        </button>
                    </div>
                `;
            } else if (data.openai) {
                html += `
                    <div class="result-card">
                        <h3>ü§ñ OpenAI Analysis</h3>
                        <div class="error">Error: ${data.openai.error || 'Unknown error'}</div>
                    </div>
                `;
            }

            if (data.google && data.google.success) {
                html += `
                    <div class="result-card google">
                        <h3>üîç Google Analysis</h3>
                        <div class="result-summary">${escapeHtml(data.google.description || 'No description')}</div>
                        ${displayStructuredData(data.google.data, 'google')}
                        <button class="btn-select" onclick="selectData('google', ${JSON.stringify(data.google.data).replace(/"/g, '&quot;')})">
                            ‚úì Use This Data
                        </button>
                    </div>
                `;
            } else if (data.google) {
                html += `
                    <div class="result-card">
                        <h3>üîç Google Analysis</h3>
                        <div class="error">Error: ${data.google.error || 'Unknown error'}</div>
                    </div>
                `;
            }

            if (data.openai && data.openai.success && data.google && data.google.success) {
                html += `
                    <div class="result-card" style="grid-column: 1 / -1;">
                        <h3>üîÑ Combined Analysis</h3>
                        <p style="margin-bottom: 15px;">Combine data from both sources</p>
                        <button class="btn-combine" onclick="combineData(${JSON.stringify(data.openai.data).replace(/"/g, '&quot;')}, ${JSON.stringify(data.google.data).replace(/"/g, '&quot;')})">
                            üîó Combine Both
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function displayStructuredData(data, source) {
            if (!data) return '';
            let html = '<div class="extracted-data-section"><h3>üìã –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3><div class="data-grid">';
            if (data.title) html += `<div class="data-item" style="grid-column: 1 / -1;"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><span>${escapeHtml(data.title)}</span></div>`;
            if (data.brand) html += `<div class="data-item"><strong>–ë—Ä–µ–Ω–¥:</strong><span>${escapeHtml(data.brand)}</span></div>`;
            if (data.model) html += `<div class="data-item"><strong>–ú–æ–¥–µ–ª—å:</strong><span style="font-weight: bold; color: #059669;">${escapeHtml(data.model)}</span></div>`;
            if (data.price) html += `<div class="data-item"><strong>–¶–µ–Ω–∞:</strong><span style="font-weight: bold; color: #dc2626;">$${data.price.toFixed(2)}</span></div>`;
            if (data.price_range) html += `<div class="data-item"><strong>–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω:</strong><span>${escapeHtml(data.price_range)}</span></div>`;
            if (data.category_id) html += `<div class="data-item"><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è ID:</strong><span>${escapeHtml(data.category_id)}</span></div>`;
            if (data.condition) html += `<div class="data-item"><strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</strong><span>${escapeHtml(data.condition)}</span></div>`;
            if (data.technical_specs && Object.keys(data.technical_specs).length > 0) {
                let techHtml = '';
                for (let key in data.technical_specs) {
                    if (key !== 'full_specs') {
                        techHtml += `<strong>${escapeHtml(key.replace(/_/g, ' '))}:</strong> ${escapeHtml(data.technical_specs[key])}<br>`;
                    }
                }
                if (data.technical_specs.full_specs) {
                    techHtml += `<div style="margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">${escapeHtml(data.technical_specs.full_specs)}</div>`;
                }
                html += `<div class="data-item" style="grid-column: 1 / -1;"><strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</strong><span>${techHtml}</span></div>`;
            }
            if (data.description) {
                // Extract eBay description if present
                let descText = data.description;
                if (descText.includes('**–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ eBay')) {
                    let ebayDescMatch = descText.match(/\*\*–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ eBay.*?:\*\*\s*([\s\S]+?)(?:\*\*|$)/);
                    if (ebayDescMatch) {
                        html += `<div class="data-item" style="grid-column: 1 / -1; background: #fef3c7; border-color: #fcd34d;"><strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è eBay:</strong><span style="white-space: pre-wrap;">${escapeHtml(ebayDescMatch[1].trim())}</span></div>`;
                    }
                }
                html += `<div class="data-item" style="grid-column: 1 / -1;"><strong>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</strong><span style="white-space: pre-wrap; font-size: 12px;">${escapeHtml(descText)}</span></div>`;
            }
            if (data.specifics && Object.keys(data.specifics).length > 0) {
                let specificsHtml = '';
                for (let key in data.specifics) {
                    specificsHtml += `<strong>${escapeHtml(key)}:</strong> ${escapeHtml(data.specifics[key])}<br>`;
                }
                html += `<div class="data-item" style="grid-column: 1 / -1;"><strong>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</strong><span>${specificsHtml}</span></div>`;
            }
            html += '</div></div>';
            return html;
        }

        function displayStockPhotos(stockPhotos, photoQueries) {
            if (!stockPhotos || stockPhotos.length === 0) {
                if (photoQueries && photoQueries.length > 0) {
                    return `<div class="stock-photos-section" style="background: #fef3c7; border-color: #fbbf24;">
                        <h3>ü§ñ OpenAI —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ</h3>
                        <div style="font-size: 13px; color: #92400e; margin-top: 10px;">
                            <strong>–ó–∞–ø—Ä–æ—Å—ã:</strong><br>
                            ${photoQueries.map(q => `‚Ä¢ ${escapeHtml(q)}`).join('<br>')}
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #78350f;">
                            –ü–æ —ç—Ç–∏–º –∑–∞–ø—Ä–æ—Å–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –Ω–∞ Google Images –∏–ª–∏ eBay.
                        </div>
                    </div>`;
                }
                return '';
            }
            
            let html = '<div class="stock-photos-section" style="background: #dbeafe; border-color: #3b82f6;"><h3>ü§ñ OpenAI –Ω–∞—à–µ–ª —Ñ–æ—Ç–æ</h3>';
            
            if (photoQueries && photoQueries.length > 0) {
                html += `<div style="font-size: 12px; color: #1e40af; margin-bottom: 15px; padding: 8px; background: #eff6ff; border-radius: 4px;">
                    <strong>–ó–∞–ø—Ä–æ—Å—ã OpenAI:</strong><br>
                    ${photoQueries.map(q => `‚Ä¢ ${escapeHtml(q)}`).join('<br>')}
                </div>`;
            }
            
            html += `<div style="font-size: 12px; color: #1e40af; margin-bottom: 10px;">–ù–∞–π–¥–µ–Ω–æ: ${stockPhotos.length} —Ñ–æ—Ç–æ</div>`;
            html += '<div class="stock-photos-grid">';
            
            stockPhotos.forEach((photo, index) => {
                const photoUrl = photo.url || photo;
                const thumbnail = photo.thumbnail || photoUrl;
                const queryTitle = photo.title || photoQueries?.[0] || 'OpenAI';
                html += `
                    <div class="stock-photo-item" onclick="openLightbox('${photoUrl}')">
                        <img src="${thumbnail}" alt="OpenAI photo ${index + 1}" onerror="this.src='${photoUrl}'">
                        <div class="stock-photo-overlay">${escapeHtml(queryTitle.substring(0, 30))}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }

        function selectData(source, data) {
            selectedData = data;
            document.getElementById('btn-continue').disabled = false;
            alert(`Selected ${source} analysis data. Click "Continue to Edit Page" to proceed.`);
        }

        function combineData(openaiData, googleData) {
            // Combine data, preferring OpenAI for most fields
            selectedData = {
                title: openaiData.title || googleData.title || '',
                description: openaiData.description || googleData.description || '',
                brand: openaiData.brand || googleData.brand || '',
                model: openaiData.model || googleData.model || '',
                category_id: openaiData.category_id || googleData.category_id || '260324',
                condition: openaiData.condition || googleData.condition || 'USED_GOOD',
                specifics: {...googleData.specifics, ...openaiData.specifics}
            };
            document.getElementById('btn-continue').disabled = false;
            alert('Combined data from both sources. Click "Continue to Edit Page" to proceed.');
        }

        function continueToEdit() {
            if (!selectedData) {
                alert('Please select analysis data first');
                return;
            }

            try {
                sessionStorage.setItem(`ebay_selected_fields_${candidateId}`, JSON.stringify(selectedData));
            } catch (e) {
                console.warn('sessionStorage not available', e);
            }
            // Save selected data to candidate
            fetch(`/api/ebay/candidates/${candidateId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify(selectedData)
            })
            .then(r => r.json())
            .then(data => {
                // Redirect to edit page
                window.location.href = `/ebay/candidates/${candidateId}/edit/`;
            })
            .catch(err => {
                alert('Error saving data: ' + err.message);
            });
        }

        function openLightbox(imageUrl) {
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            lightbox.appendChild(img);
            lightbox.onclick = () => lightbox.remove();
            document.body.appendChild(lightbox);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyCompListing(comp) {
            // Store comp data for potential use in edit page
            localStorage.setItem('ebay_comp_copy', JSON.stringify(comp));
            
            // Show notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                ‚úÖ <strong>Copied!</strong><br>
                Title: ${comp.title ? comp.title.substring(0, 40) + '...' : 'N/A'}<br>
                Price: $${comp.price ? comp.price.toFixed(2) : 'N/A'}
            `;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // Copy basic info to clipboard as text
            const copyText = `Title: ${comp.title || 'N/A'}\nPrice: $${comp.price ? comp.price.toFixed(2) : 'N/A'}\nCondition: ${comp.condition || 'N/A'}\nURL: ${comp.url || 'N/A'}`;
            navigator.clipboard.writeText(copyText).catch(err => console.log('Clipboard copy failed:', err));
        }

        function continueToEdit() {
            if (!selectedData) {
                alert('Please select or combine analysis data first');
                return;
            }
            window.location.href = `/ebay/candidates/${candidateId}/edit/`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const section = document.querySelector('.analysis-section');
            if (!section || section.querySelector('.btn-autofill')) {
                return;
            }
            const wrapper = document.createElement('div');
            wrapper.className = 'results-container';
            wrapper.style.marginTop = '20px';
            wrapper.style.background = '#f0fdf4';
            wrapper.style.border = '2px solid #6ee7b7';
            wrapper.style.borderRadius = '10px';
            wrapper.style.padding = '18px';
            wrapper.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:240px;">
                        <h3 style="color:#047857; margin-bottom:6px;">‚ú® Auto-fill Listing</h3>
                        <p style="font-size:13px; color:#047857;">
                            –°–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å GPT, Google –∏ eBay comps –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                        </p>
                    </div>
                    <button class="btn-autofill" onclick="autoFillCandidate()">
                        ‚ú® Auto-fill Listing
                    </button>
                </div>
            `;
            section.appendChild(wrapper);
        });

        // Photo management functions
        async function deletePhoto(photoId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/photos/api/delete-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const photoElement = document.getElementById(`photo-${photoId}`);
                    if (photoElement) {
                        photoElement.remove();
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function setMainPhoto(photoId) {
            try {
                const response = await fetch(`/photos/api/set-main-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≥–ª–∞–≤–Ω–æ–π —Ñ–æ—Ç–æ: ' + error.message);
            }
        }
        
        async function rotatePhoto(photoId, direction = 'right') {
            const photoElement = document.getElementById(`photo-${photoId}`);
            const img = photoElement ? photoElement.querySelector('img') : null;
            
            if (img) {
                img.style.opacity = '0.5';
            }
            
            try {
                const response = await fetch(`/photos/api/rotate-photo/${photoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ direction: direction }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (img) {
                        img.src = data.photo_url + '?t=' + Date.now();
                        img.style.opacity = '1';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —Ñ–æ—Ç–æ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    if (img) {
                        img.style.opacity = '1';
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ —Ñ–æ—Ç–æ: ' + error.message);
                if (img) {
                    img.style.opacity = '1';
                }
            }
        }

        // FASHN API functions
        async function enhancePhoto(photoId, mode = 'ghost_mannequin') {
            const photoElement = document.getElementById(`photo-${photoId}`);
            const img = photoElement ? photoElement.querySelector('img') : null;
            const btnEnhance = photoElement ? photoElement.querySelector('.btn-enhance') : null;
            const btnMannequin = photoElement ? photoElement.querySelector('.btn-mannequin') : null;
            
            if (img) {
                img.style.opacity = '0.5';
            }
            
            if (btnEnhance) btnEnhance.disabled = true;
            if (btnMannequin) btnMannequin.disabled = true;
            
            try {
                const url = `/photos/api/enhance-photo/${photoId}/`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 150000);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode }),
                    signal: controller.signal
                }).finally(() => clearTimeout(timeoutId));
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.reload) {
                        window.location.reload();
                    } else if (img) {
                        img.src = data.photo_url + '?t=' + Date.now();
                        img.style.opacity = '1';
                    }
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞ FASHN AI:\n${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    if (img) {
                        img.style.opacity = '1';
                    }
                }
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:\n${error.message}`);
                if (img) {
                    img.style.opacity = '1';
                }
            } finally {
                if (btnEnhance) btnEnhance.disabled = false;
                if (btnMannequin) btnMannequin.disabled = false;
            }
        }

        // Lightbox for photo viewing
        function openLightbox(imageUrl) {
            const lightbox = document.createElement('div');
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            lightbox.appendChild(img);
            document.body.appendChild(lightbox);
            
            lightbox.onclick = () => {
                document.body.removeChild(lightbox);
            };
        }
    </script>
</body>
</html>

